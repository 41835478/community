<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <title>TianDi Map</title>
    
    <script type="text/javascript">
        dojoConfig = {
            parseOnLoad: true,
            packages: [{
                name: 'tdlib',
                location: "/nh/js/tdlib"
            }]
        };
    </script>
      <link rel="stylesheet" href="https://js.arcgis.com/3.21/dijit/themes/claro/claro.css">
    <link rel="stylesheet" href="https://js.arcgis.com/3.21/esri/css/esri.css">
    
   <script src="https://js.arcgis.com/3.21/"></script>
    

    <script type="text/javascript">
    var map,tb;
    
    require(["esri/map","esri/dijit/Popup","esri/dijit/PopupTemplate","esri/toolbars/draw","esri/symbols/SimpleMarkerSymbol","esri/symbols/SimpleLineSymbol", "esri/symbols/SimpleFillSymbol", "esri/graphic","esri/Color","esri/layers/GraphicsLayer", "esri/SpatialReference","tdlib/TDTLayer","tdlib/TDTAnnoLayer","esri/geometry/Point","dojo/parser","dijit/registry","dijit/form/Button", "dojo/domReady!"], 
    function(Map,Popup, PopupTemplate,Draw,SimpleMarkerSymbol, SimpleLineSymbol, SimpleFillSymbol, Graphic,Color,GraphicsLayer,SpatialReference,TDTLayer,TDTAnnoLayer,Point,parser,registry,Button) {
        parser.parse();
        var popupOptions = {
						titleInBody: false,
						highlight: true,
						marginTop: 60,
						width: 100
				};
				var popup = new esri.dijit.Popup(popupOptions, dojo.create("div"));
        map=new Map("mapDiv",{ logo:false,infoWindow: popup});
        map.on('load', function() {        	
						alert('地图加载结束\n这里可以触发加载小区数据事件');
						requestData();
					});
        var nhbasemap = new TDTLayer();
        map.addLayer(nhbasemap);
        var nhannolayer=  new TDTAnnoLayer();
        map.addLayer(nhannolayer);
        
        map.centerAndZoom(new Point({"x": 121.42018376109351, "y": 29.291107035766274, "spatialReference": {"wkid": 4490 } }),11);
        var graLayer = new GraphicsLayer({id:"xiaoqu"});  
				map.addLayer(graLayer);  
							              		 
        registry.byId("ToNinghai").on("click", function() {
          	map.centerAt(new esri.geometry.Point(121.42018376109351,29.291107035766274, new esri.SpatialReference({ wkid: 4490 })));
        });
        
        registry.byId("clear").on("click", function() {
        		//清除所有绘制的面数据
          	map.graphics.clear();
          	//清除graphiclayer图层的数据
          	map.getLayer("xiaoqu").clear();
          	
        });
        
        tb = new Draw(map);
        tb.on("draw-end", addGraphic);
     		registry.byId("Polygon").on("click", function() {
          	tb.activate(this.id.toLowerCase());
        });
         	
         	
         	function addGraphic(evt){
          		var r = Math.floor(Math.random() * 255);
	          	var g = Math.floor(Math.random() * 255);
	          	var b = Math.floor(Math.random() * 255);
	         		//alert(evt.geometry.type);
	         		 tb.deactivate(); 
	          	 //map.enableMapNavigation();	
	          	 var symbol = new SimpleFillSymbol(
	              SimpleFillSymbol.STYLE_SOLID,
	              new SimpleLineSymbol(
	                SimpleLineSymbol.STYLE_SOLID,
	                new Color([r,g,b,0.9]), 
	                4
	              ),new Color([r,g,b,0.5]));
							map.graphics.add(new Graphic(evt.geometry, symbol));
							//evt.geometry.rings[0] 坐标串
							//evt.geometry.spatialReference.wkid 参考系
							//evt.geometry.type  图形类型
							//
							//https://developers.arcgis.com/javascript/3/jssamples/toolbar_draw.html
         	}
         	
         	function requestData(){
      		dojo.xhrGet({

							       url:"data/c123_FeaturesToJSON.json",						
							
							       handleAs:'json',
							
							       handle:function(resp){
							
							              //获取图形
							              if(resp.features.length > 0)
							              {
							              		
							              		//获取属性
							              		var attr = resp.features[0].attributes;
							              		//获取图形
							              		var geo = resp.features[0].geometry;
							              		//绘制图形
							              		
							              		var polygon = new esri.geometry.Polygon(new SpatialReference({wkid:4490}));  
							              		polygon.rings = geo.rings;
							              		var symbol = new SimpleFillSymbol(SimpleFillSymbol.STYLE_SOLID,
																		    new SimpleLineSymbol(SimpleLineSymbol.STYLE_DASHDOT,
																		    new Color([255,0,0]), 2),new Color([255,255,0,0.25]));
																 //var polygon = new esri.geometry.Polygon(resp);
							              		 var graphic = new Graphic(polygon,symbol);  
							              		 graLayer.add(graphic);
							              		 map.centerAndZoom(graphic.geometry.getCentroid(),15); 
							              		 //graphic.toJson();  转成json数据保存
																
																//添加图标
																
																var symbol = new esri.symbol.PictureMarkerSymbol("images/grn_pushpin_48px", 48, 48);
												
												        //创建模版
												        var popupTemplate = esri.dijit.PopupTemplate({
																			title: "小区详细信息",
																			fieldInfos: [{
																					fieldName: "小区名",
																					label: "名称",
																					visible: true
																				}, {
																					fieldName: "地址",
																					label: "地址",
																					visible: true
																				}, {
																					fieldName: "幢数",
																					label: "幢数",
																					visible: true
																				}, {
																					fieldName: "单元数",
																					label: "单元数",
																					visible: true
																				},
																				{
																					fieldName:"电梯数",
																					label:"电梯数",
																				  visible:true
																				},
																				{
																					fieldName:"物业公",
																					label:"物业公司",
																				  visible:true
																				},
																				{
																					fieldName:"负责人",
																					label:"负责人",
																				  visible:true
																				},
																				{
																					fieldName:"联系电",
																					label:"联系电话",
																				  visible:true
																				},
																				{
																					fieldName: "Link",
																					label: "更多详细信息",
																					visible: true
																				}
																			]
																		});

																var attributes = attr;
																attributes["Link"]="http://www.baidu.com";
																var ptgraphic = new esri.Graphic(graphic.geometry.getCentroid(), symbol, attr, popupTemplate);
																graLayer.add(ptgraphic);
							              }
							              
							
							      }
							
							});
      } 
         	
         	registry.byId("phpdata").on("click", function() {
        			requestData();
        });
         	
         	                                 
      });      
      
      
      
         	
         	
    </script>
  </head>
  <body class="claro">
    <button id="ToNinghai" data-dojo-type="dijit/form/Button">宁海</button>
    <button id="Polygon" data-dojo-type="dijit/form/Button">绘制面数据</button>
    <button id="clear" data-dojo-type="dijit/form/Button">清除面数据</button>
    <button id="phpdata" data-dojo-type="dijit/form/Button">PHP传输</button>
    <div id="mapDiv" style="width:1000px; height:500px; border:1px solid #000;"></div>
  </body>
</html>