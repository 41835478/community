// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.21/esri/copyright.txt for details.
//>>built
require({cache:{"dojo/debounce":function(){define([],function(){return function(k,n){var e;return function(){e&&clearTimeout(e);var d=this,g=arguments;e=setTimeout(function(){k.apply(d,g)},n)}}})},"dojo/DeferredList":function(){define(["./_base/kernel","./_base/Deferred","./_base/array"],function(k,n,e){k.DeferredList=function(d,g,t,u,a){var m=[];n.call(this);var k=this;0!==d.length||g||this.resolve([0,[]]);var F=0;e.forEach(d,function(a,e){function n(c,a){m[e]=[c,a];F++;F===d.length&&k.resolve(m)}
a.then(function(c){g?k.resolve([e,c]):n(!0,c)},function(c){t?k.reject(c):n(!1,c);if(u)return null;throw c;})})};k.DeferredList.prototype=new n;k.DeferredList.prototype.gatherResults=function(d){d=new k.DeferredList(d,!1,!0,!1);d.addCallback(function(d){var g=[];e.forEach(d,function(d){g.push(d[1])});return g});return d};return k.DeferredList})},"dijit/_Widget":function(){define("dojo/aspect dojo/_base/config dojo/_base/connect dojo/_base/declare dojo/has dojo/_base/kernel dojo/_base/lang dojo/query dojo/ready ./registry ./_WidgetBase ./_OnDijitClickMixin ./_FocusMixin dojo/uacss ./hccss".split(" "),
function(k,n,e,d,g,t,u,a,m,L,F,y,B){function q(){}function c(c){return function(a,h,d,m){return a&&"string"==typeof h&&a[h]==q?a.on(h.substring(2).toLowerCase(),u.hitch(d,m)):c.apply(e,arguments)}}k.around(e,"connect",c);t.connect&&k.around(t,"connect",c);k=d("dijit._Widget",[F,y,B],{onClick:q,onDblClick:q,onKeyDown:q,onKeyPress:q,onKeyUp:q,onMouseDown:q,onMouseMove:q,onMouseOut:q,onMouseOver:q,onMouseLeave:q,onMouseEnter:q,onMouseUp:q,constructor:function(c){this._toConnect={};for(var a in c)this[a]===
q&&(this._toConnect[a.replace(/^on/,"").toLowerCase()]=c[a],delete c[a])},postCreate:function(){this.inherited(arguments);for(var c in this._toConnect)this.on(c,this._toConnect[c]);delete this._toConnect},on:function(c,a){return this[this._onMap(c)]===q?e.connect(this.domNode,c.toLowerCase(),this,a):this.inherited(arguments)},_setFocusedAttr:function(c){this._focused=c;this._set("focused",c)},setAttribute:function(c,a){t.deprecated(this.declaredClass+"::setAttribute(attr, value) is deprecated. Use set() instead.",
"","2.0");this.set(c,a)},attr:function(c,a){return 2<=arguments.length||"object"===typeof c?this.set.apply(this,arguments):this.get(c)},getDescendants:function(){t.deprecated(this.declaredClass+"::getDescendants() is deprecated. Use getChildren() instead.","","2.0");return this.containerNode?a("[widgetId]",this.containerNode).map(L.byNode):[]},_onShow:function(){this.onShow()},onShow:function(){},onHide:function(){},onClose:function(){return!0}});g("dijit-legacy-requires")&&m(0,function(){require(["dijit/_base"])});
return k})},"dijit/_WidgetBase":function(){define("require dojo/_base/array dojo/aspect dojo/_base/config dojo/_base/connect dojo/_base/declare dojo/dom dojo/dom-attr dojo/dom-class dojo/dom-construct dojo/dom-geometry dojo/dom-style dojo/has dojo/_base/kernel dojo/_base/lang dojo/on dojo/ready dojo/Stateful dojo/topic dojo/_base/window ./Destroyable dojo/has!dojo-bidi?./_BidiMixin ./registry".split(" "),function(k,n,e,d,g,t,u,a,m,L,F,y,B,q,c,x,J,h,v,H,D,Q,I){function N(c){return function(E){a[E?
"set":"remove"](this.domNode,c,E);this._set(c,E)}}B.add("dijit-legacy-requires",!q.isAsync);B.add("dojo-bidi",!1);B("dijit-legacy-requires")&&J(0,function(){k(["dijit/_base/manager"])});var K={};d=t("dijit._WidgetBase",[h,D],{id:"",_setIdAttr:"domNode",lang:"",_setLangAttr:N("lang"),dir:"",_setDirAttr:N("dir"),"class":"",_setClassAttr:{node:"domNode",type:"class"},_setTypeAttr:null,style:"",title:"",tooltip:"",baseClass:"",srcNodeRef:null,domNode:null,containerNode:null,ownerDocument:null,_setOwnerDocumentAttr:function(c){this._set("ownerDocument",
c)},attributeMap:{},_blankGif:d.blankGif||k.toUrl("dojo/resources/blank.gif"),textDir:"",_introspect:function(){var c=this.constructor;if(!c._setterAttrs){var a=c.prototype,d=c._setterAttrs=[],c=c._onMap={},h;for(h in a.attributeMap)d.push(h);for(h in a)/^on/.test(h)&&(c[h.substring(2).toLowerCase()]=h),/^_set[A-Z](.*)Attr$/.test(h)&&(h=h.charAt(4).toLowerCase()+h.substr(5,h.length-9),a.attributeMap&&h in a.attributeMap||d.push(h))}},postscript:function(c,a){this.create(c,a)},create:function(a,h){this._introspect();
this.srcNodeRef=u.byId(h);this._connects=[];this._supportingWidgets=[];this.srcNodeRef&&this.srcNodeRef.id&&"string"==typeof this.srcNodeRef.id&&(this.id=this.srcNodeRef.id);a&&(this.params=a,c.mixin(this,a));this.postMixInProperties();this.id||(this.id=I.getUniqueId(this.declaredClass.replace(/\./g,"_")),this.params&&delete this.params.id);this.ownerDocument=this.ownerDocument||(this.srcNodeRef?this.srcNodeRef.ownerDocument:document);this.ownerDocumentBody=H.body(this.ownerDocument);I.add(this);
this.buildRendering();var E;if(this.domNode){this._applyAttributes();var d=this.srcNodeRef;d&&d.parentNode&&this.domNode!==d&&(d.parentNode.replaceChild(this.domNode,d),E=!0);this.domNode.setAttribute("widgetId",this.id)}this.postCreate();E&&delete this.srcNodeRef;this._created=!0},_applyAttributes:function(){var c={},a;for(a in this.params||{})c[a]=this._get(a);n.forEach(this.constructor._setterAttrs,function(a){if(!(a in c)){var h=this._get(a);h&&this.set(a,h)}},this);for(a in c)this.set(a,c[a])},
postMixInProperties:function(){},buildRendering:function(){this.domNode||(this.domNode=this.srcNodeRef||this.ownerDocument.createElement("div"));if(this.baseClass){var c=this.baseClass.split(" ");this.isLeftToRight()||(c=c.concat(n.map(c,function(c){return c+"Rtl"})));m.add(this.domNode,c)}},postCreate:function(){},startup:function(){this._started||(this._started=!0,n.forEach(this.getChildren(),function(a){a._started||a._destroyed||!c.isFunction(a.startup)||(a.startup(),a._started=!0)}))},destroyRecursive:function(c){this._beingDestroyed=
!0;this.destroyDescendants(c);this.destroy(c)},destroy:function(a){function h(c){c.destroyRecursive?c.destroyRecursive(a):c.destroy&&c.destroy(a)}this._beingDestroyed=!0;this.uninitialize();n.forEach(this._connects,c.hitch(this,"disconnect"));n.forEach(this._supportingWidgets,h);this.domNode&&n.forEach(I.findWidgets(this.domNode,this.containerNode),h);this.destroyRendering(a);I.remove(this.id);this._destroyed=!0},destroyRendering:function(c){this.bgIframe&&(this.bgIframe.destroy(c),delete this.bgIframe);
this.domNode&&(c?a.remove(this.domNode,"widgetId"):L.destroy(this.domNode),delete this.domNode);this.srcNodeRef&&(c||L.destroy(this.srcNodeRef),delete this.srcNodeRef)},destroyDescendants:function(c){n.forEach(this.getChildren(),function(a){a.destroyRecursive&&a.destroyRecursive(c)})},uninitialize:function(){return!1},_setStyleAttr:function(a){var h=this.domNode;c.isObject(a)?y.set(h,a):h.style.cssText=h.style.cssText?h.style.cssText+("; "+a):a;this._set("style",a)},_attrToDom:function(h,d,v){v=3<=
arguments.length?v:this.attributeMap[h];n.forEach(c.isArray(v)?v:[v],function(v){var g=this[v.node||v||"domNode"];switch(v.type||"attribute"){case "attribute":c.isFunction(d)&&(d=c.hitch(this,d));v=v.attribute?v.attribute:/^on[A-Z][a-zA-Z]*$/.test(h)?h.toLowerCase():h;g.tagName?a.set(g,v,d):g.set(v,d);break;case "innerText":g.innerHTML="";g.appendChild(this.ownerDocument.createTextNode(d));break;case "innerHTML":g.innerHTML=d;break;case "class":m.replace(g,d,this[h]);break;case "toggleClass":m.toggle(g,
v.className||h,d)}},this)},get:function(c){var a=this._getAttrNames(c);return this[a.g]?this[a.g]():this._get(c)},set:function(a,h){if("object"===typeof a){for(var d in a)this.set(d,a[d]);return this}d=this._getAttrNames(a);var v=this[d.s];if(c.isFunction(v))var m=v.apply(this,Array.prototype.slice.call(arguments,1));else{var v=this.focusNode&&!c.isFunction(this.focusNode)?"focusNode":"domNode",g=this[v]&&this[v].tagName,u;if((u=g)&&!(u=K[g])){u=this[v];var t={},e;for(e in u)t[e.toLowerCase()]=!0;
u=K[g]=t}e=u;d=a in this.attributeMap?this.attributeMap[a]:d.s in this?this[d.s]:e&&d.l in e&&"function"!=typeof h||/^aria-|^data-|^role$/.test(a)?v:null;null!=d&&this._attrToDom(a,h,d);this._set(a,h)}return m||this},_attrPairNames:{},_getAttrNames:function(c){var a=this._attrPairNames;if(a[c])return a[c];var h=c.replace(/^[a-z]|-[a-zA-Z]/g,function(c){return c.charAt(c.length-1).toUpperCase()});return a[c]={n:c+"Node",s:"_set"+h+"Attr",g:"_get"+h+"Attr",l:h.toLowerCase()}},_set:function(c,a){var h=
this[c];this[c]=a;!this._created||h===a||h!==h&&a!==a||(this._watchCallbacks&&this._watchCallbacks(c,h,a),this.emit("attrmodified-"+c,{detail:{prevValue:h,newValue:a}}))},_get:function(c){return this[c]},emit:function(c,a,h){a=a||{};void 0===a.bubbles&&(a.bubbles=!0);void 0===a.cancelable&&(a.cancelable=!0);a.detail||(a.detail={});a.detail.widget=this;var d,v=this["on"+c];v&&(d=v.apply(this,h?h:[a]));this._started&&!this._beingDestroyed&&x.emit(this.domNode,c.toLowerCase(),a);return d},on:function(c,
a){var h=this._onMap(c);return h?e.after(this,h,a,!0):this.own(x(this.domNode,c,a))[0]},_onMap:function(c){var a=this.constructor,h=a._onMap;if(!h){var h=a._onMap={},d;for(d in a.prototype)/^on/.test(d)&&(h[d.replace(/^on/,"").toLowerCase()]=d)}return h["string"==typeof c&&c.toLowerCase()]},toString:function(){return"[Widget "+this.declaredClass+", "+(this.id||"NO ID")+"]"},getChildren:function(){return this.containerNode?I.findWidgets(this.containerNode):[]},getParent:function(){return I.getEnclosingWidget(this.domNode.parentNode)},
connect:function(c,a,h){return this.own(g.connect(c,a,this,h))[0]},disconnect:function(c){c.remove()},subscribe:function(a,h){return this.own(v.subscribe(a,c.hitch(this,h)))[0]},unsubscribe:function(c){c.remove()},isLeftToRight:function(){return this.dir?"ltr"==this.dir.toLowerCase():F.isBodyLtr(this.ownerDocument)},isFocusable:function(){return this.focus&&"none"!=y.get(this.domNode,"display")},placeAt:function(c,a){var h=!c.tagName&&I.byId(c);!h||!h.addChild||a&&"number"!==typeof a?(h=h&&"domNode"in
h?h.containerNode&&!/after|before|replace/.test(a||"")?h.containerNode:h.domNode:u.byId(c,this.ownerDocument),L.place(this.domNode,h,a),!this._started&&(this.getParent()||{})._started&&this.startup()):h.addChild(this,a);return this},defer:function(a,h){var d=setTimeout(c.hitch(this,function(){d&&(d=null,this._destroyed||c.hitch(this,a)())}),h||0);return{remove:function(){d&&(clearTimeout(d),d=null);return null}}}});B("dojo-bidi")&&d.extend(Q);return d})},"dijit/Destroyable":function(){define(["dojo/_base/array",
"dojo/aspect","dojo/_base/declare"],function(k,n,e){return e("dijit.Destroyable",null,{destroy:function(d){this._destroyed=!0},own:function(){var d=["destroyRecursive","destroy","remove"];k.forEach(arguments,function(g){function e(){a.remove();k.forEach(m,function(a){a.remove()})}var u,a=n.before(this,"destroy",function(a){g[u](a)}),m=[];g.then?(u="cancel",g.then(e,e)):k.forEach(d,function(a){"function"===typeof g[a]&&(u||(u=a),m.push(n.after(g,a,e,!0)))})},this);return arguments}})})},"dijit/_OnDijitClickMixin":function(){define("dojo/on dojo/_base/array dojo/keys dojo/_base/declare dojo/has ./a11yclick".split(" "),
function(k,n,e,d,g,t){k=d("dijit._OnDijitClickMixin",null,{connect:function(d,a,m){return this.inherited(arguments,[d,"ondijitclick"==a?t:a,m])}});k.a11yclick=t;return k})},"dijit/_FocusMixin":function(){define(["./focus","./_WidgetBase","dojo/_base/declare","dojo/_base/lang"],function(k,n,e,d){d.extend(n,{focused:!1,onFocus:function(){},onBlur:function(){},_onFocus:function(){this.onFocus()},_onBlur:function(){this.onBlur()}});return e("dijit._FocusMixin",null,{_focusManager:k})})},"dijit/hccss":function(){define(["dojo/dom-class",
"dojo/hccss","dojo/domReady","dojo/_base/window"],function(k,n,e,d){e(function(){n("highcontrast")&&k.add(d.body(),"dijit_a11y")});return n})},"dojo/hccss":function(){define("require ./_base/config ./dom-class ./dom-style ./has ./domReady ./_base/window".split(" "),function(k,n,e,d,g,t,u){g.add("highcontrast",function(){var a=u.doc.createElement("div");try{a.style.cssText='border: 1px solid; border-color:red green; position: absolute; height: 5px; top: -999px;background-image: url("'+(n.blankGif||
k.toUrl("./resources/blank.gif"))+'");';u.body().appendChild(a);var m=d.getComputedStyle(a),e=m.backgroundImage;return m.borderTopColor==m.borderRightColor||e&&("none"==e||"url(invalid-url:)"==e)}catch(F){return console.warn("hccss: exception detecting high-contrast mode, document is likely hidden: "+F.toString()),!1}finally{8>=g("ie")?a.outerHTML="":u.body().removeChild(a)}});t(function(){g("highcontrast")&&e.add(u.body(),"dj_a11y")});return g})},"dojox/html/entities":function(){define(["dojo/_base/lang"],
function(k){var n=k.getObject("dojox.html.entities",!0),e=function(d,e){var g,a;if(e._encCache&&e._encCache.regexp&&e._encCache.mapper&&e.length==e._encCache.length)g=e._encCache.mapper,a=e._encCache.regexp;else{g={};a=["["];var m;for(m=0;m<e.length;m++)g[e[m][0]]="\x26"+e[m][1]+";",a.push(e[m][0]);a.push("]");a=new RegExp(a.join(""),"g");e._encCache={mapper:g,regexp:a,length:e.length}}return d=d.replace(a,function(a){return g[a]})},d=function(d,e){var g,a;if(e._decCache&&e._decCache.regexp&&e._decCache.mapper&&
e.length==e._decCache.length)g=e._decCache.mapper,a=e._decCache.regexp;else{g={};a=["("];var m;for(m=0;m<e.length;m++){var k="\x26"+e[m][1]+";";m&&a.push("|");g[k]=e[m][0];a.push(k)}a.push(")");a=new RegExp(a.join(""),"g");e._decCache={mapper:g,regexp:a,length:e.length}}return d=d.replace(a,function(a){return g[a]})};n.html=[["\x26","amp"],['"',"quot"],["\x3c","lt"],["\x3e","gt"],["\u00a0","nbsp"]];n.latin=[["\u00a1","iexcl"],["\u00a2","cent"],["\u00a3","pound"],["\u20ac","euro"],["\u00a4","curren"],
["\u00a5","yen"],["\u00a6","brvbar"],["\u00a7","sect"],["\u00a8","uml"],["\u00a9","copy"],["\u00aa","ordf"],["\u00ab","laquo"],["\u00ac","not"],["\u00ad","shy"],["\u00ae","reg"],["\u00af","macr"],["\u00b0","deg"],["\u00b1","plusmn"],["\u00b2","sup2"],["\u00b3","sup3"],["\u00b4","acute"],["\u00b5","micro"],["\u00b6","para"],["\u00b7","middot"],["\u00b8","cedil"],["\u00b9","sup1"],["\u00ba","ordm"],["\u00bb","raquo"],["\u00bc","frac14"],["\u00bd","frac12"],["\u00be","frac34"],["\u00bf","iquest"],["\u00c0",
"Agrave"],["\u00c1","Aacute"],["\u00c2","Acirc"],["\u00c3","Atilde"],["\u00c4","Auml"],["\u00c5","Aring"],["\u00c6","AElig"],["\u00c7","Ccedil"],["\u00c8","Egrave"],["\u00c9","Eacute"],["\u00ca","Ecirc"],["\u00cb","Euml"],["\u00cc","Igrave"],["\u00cd","Iacute"],["\u00ce","Icirc"],["\u00cf","Iuml"],["\u00d0","ETH"],["\u00d1","Ntilde"],["\u00d2","Ograve"],["\u00d3","Oacute"],["\u00d4","Ocirc"],["\u00d5","Otilde"],["\u00d6","Ouml"],["\u00d7","times"],["\u00d8","Oslash"],["\u00d9","Ugrave"],["\u00da",
"Uacute"],["\u00db","Ucirc"],["\u00dc","Uuml"],["\u00dd","Yacute"],["\u00de","THORN"],["\u00df","szlig"],["\u00e0","agrave"],["\u00e1","aacute"],["\u00e2","acirc"],["\u00e3","atilde"],["\u00e4","auml"],["\u00e5","aring"],["\u00e6","aelig"],["\u00e7","ccedil"],["\u00e8","egrave"],["\u00e9","eacute"],["\u00ea","ecirc"],["\u00eb","euml"],["\u00ec","igrave"],["\u00ed","iacute"],["\u00ee","icirc"],["\u00ef","iuml"],["\u00f0","eth"],["\u00f1","ntilde"],["\u00f2","ograve"],["\u00f3","oacute"],["\u00f4",
"ocirc"],["\u00f5","otilde"],["\u00f6","ouml"],["\u00f7","divide"],["\u00f8","oslash"],["\u00f9","ugrave"],["\u00fa","uacute"],["\u00fb","ucirc"],["\u00fc","uuml"],["\u00fd","yacute"],["\u00fe","thorn"],["\u00ff","yuml"],["\u0192","fnof"],["\u0391","Alpha"],["\u0392","Beta"],["\u0393","Gamma"],["\u0394","Delta"],["\u0395","Epsilon"],["\u0396","Zeta"],["\u0397","Eta"],["\u0398","Theta"],["\u0399","Iota"],["\u039a","Kappa"],["\u039b","Lambda"],["\u039c","Mu"],["\u039d","Nu"],["\u039e","Xi"],["\u039f",
"Omicron"],["\u03a0","Pi"],["\u03a1","Rho"],["\u03a3","Sigma"],["\u03a4","Tau"],["\u03a5","Upsilon"],["\u03a6","Phi"],["\u03a7","Chi"],["\u03a8","Psi"],["\u03a9","Omega"],["\u03b1","alpha"],["\u03b2","beta"],["\u03b3","gamma"],["\u03b4","delta"],["\u03b5","epsilon"],["\u03b6","zeta"],["\u03b7","eta"],["\u03b8","theta"],["\u03b9","iota"],["\u03ba","kappa"],["\u03bb","lambda"],["\u03bc","mu"],["\u03bd","nu"],["\u03be","xi"],["\u03bf","omicron"],["\u03c0","pi"],["\u03c1","rho"],["\u03c2","sigmaf"],["\u03c3",
"sigma"],["\u03c4","tau"],["\u03c5","upsilon"],["\u03c6","phi"],["\u03c7","chi"],["\u03c8","psi"],["\u03c9","omega"],["\u03d1","thetasym"],["\u03d2","upsih"],["\u03d6","piv"],["\u2022","bull"],["\u2026","hellip"],["\u2032","prime"],["\u2033","Prime"],["\u203e","oline"],["\u2044","frasl"],["\u2118","weierp"],["\u2111","image"],["\u211c","real"],["\u2122","trade"],["\u2135","alefsym"],["\u2190","larr"],["\u2191","uarr"],["\u2192","rarr"],["\u2193","darr"],["\u2194","harr"],["\u21b5","crarr"],["\u21d0",
"lArr"],["\u21d1","uArr"],["\u21d2","rArr"],["\u21d3","dArr"],["\u21d4","hArr"],["\u2200","forall"],["\u2202","part"],["\u2203","exist"],["\u2205","empty"],["\u2207","nabla"],["\u2208","isin"],["\u2209","notin"],["\u220b","ni"],["\u220f","prod"],["\u2211","sum"],["\u2212","minus"],["\u2217","lowast"],["\u221a","radic"],["\u221d","prop"],["\u221e","infin"],["\u2220","ang"],["\u2227","and"],["\u2228","or"],["\u2229","cap"],["\u222a","cup"],["\u222b","int"],["\u2234","there4"],["\u223c","sim"],["\u2245",
"cong"],["\u2248","asymp"],["\u2260","ne"],["\u2261","equiv"],["\u2264","le"],["\u2265","ge"],["\u2282","sub"],["\u2283","sup"],["\u2284","nsub"],["\u2286","sube"],["\u2287","supe"],["\u2295","oplus"],["\u2297","otimes"],["\u22a5","perp"],["\u22c5","sdot"],["\u2308","lceil"],["\u2309","rceil"],["\u230a","lfloor"],["\u230b","rfloor"],["\u2329","lang"],["\u232a","rang"],["\u25ca","loz"],["\u2660","spades"],["\u2663","clubs"],["\u2665","hearts"],["\u2666","diams"],["\u0152","OElig"],["\u0153","oelig"],
["\u0160","Scaron"],["\u0161","scaron"],["\u0178","Yuml"],["\u02c6","circ"],["\u02dc","tilde"],["\u2002","ensp"],["\u2003","emsp"],["\u2009","thinsp"],["\u200c","zwnj"],["\u200d","zwj"],["\u200e","lrm"],["\u200f","rlm"],["\u2013","ndash"],["\u2014","mdash"],["\u2018","lsquo"],["\u2019","rsquo"],["\u201a","sbquo"],["\u201c","ldquo"],["\u201d","rdquo"],["\u201e","bdquo"],["\u2020","dagger"],["\u2021","Dagger"],["\u2030","permil"],["\u2039","lsaquo"],["\u203a","rsaquo"]];n.encode=function(d,k){d&&(k?
d=e(d,k):(d=e(d,n.html),d=e(d,n.latin)));return d};n.decode=function(e,k){e&&(k?e=d(e,k):(e=d(e,n.html),e=d(e,n.latin)));return e};return n})},"esri/numberUtils":function(){define(["dojo/has","dojo/number","dojo/i18n!dojo/cldr/nls/number","./kernel"],function(k,n,e,d){var g=function(d,a){return d-a},t={_reNumber:/^-?(\d+)(\.(\d+))?$/i,getDigits:function(d){var a=String(d),e=a.match(t._reNumber);d={integer:0,fractional:0};e&&e[1]?(d.integer=e[1].split("").length,d.fractional=e[3]?e[3].split("").length:
0):-1<a.toLowerCase().indexOf("e")&&(e=a.split("e"),a=e[0],e=e[1],a&&e&&(a=Number(a),e=Number(e),(d=0<e)||(e=Math.abs(e)),a=t.getDigits(a),d?(a.integer+=e,a.fractional=e>a.fractional?0:a.fractional-e):(a.fractional+=e,a.integer=e>a.integer?1:a.integer-e),d=a));return d},getFixedNumbers:function(d,a){var e,g;e=Number(d.toFixed(a));e<d?g=e+1/Math.pow(10,a):(g=e,e-=1/Math.pow(10,a));e=Number(e.toFixed(a));g=Number(g.toFixed(a));return[e,g]},getPctChange:function(d,a,e,g){var m={prev:null,next:null},
k;null!=e&&(k=d-e,m.prev=Math.floor(Math.abs(100*(a-e-k)/k)));null!=g&&(k=g-d,m.next=Math.floor(Math.abs(100*(g-a-k)/k)));return m},round:function(d,a){var e=d.slice(0),k,u,n,B,q,c,x,J,h,v=a&&null!=a.tolerance?a.tolerance:2,H=a&&a.indexes,D=a&&null!=a.strictBounds?a.strictBounds:!1;if(H)H.sort(g);else for(H=[],c=0;c<e.length;c++)H.push(c);for(c=0;c<H.length;c++)if(h=H[c],k=e[h],u=0===h?null:e[h-1],n=h===e.length-1?null:e[h+1],B=t.getDigits(k),B=B.fractional){x=0;for(J=!1;x<=B&&!J;)q=t.getFixedNumbers(k,
x),q=D&&0===c?q[1]:q[0],J=t.hasMinimalChange(k,q,u,n,v),x++;J&&(e[h]=q)}return e},hasMinimalChange:function(d,a,e,g,k){d=t.getPctChange(d,a,e,g);a=null==d.prev||d.prev<=k;e=null==d.next||d.next<=k;return a&&e||d.prev+d.next<=2*k},_reAllZeros:new RegExp("\\"+e.decimal+"0+$","g"),_reSomeZeros:RegExp("(\\d)0*$","g"),format:function(d,a){a=a||{places:20,round:-1};var e=n.format(d,a);e&&(e=e.replace(t._reSomeZeros,"$1").replace(t._reAllZeros,""));return e}};k("extend-esri")&&(d.numberUtils=t);return t})},
"esri/renderers/utils":function(){define("dojo/_base/lang dojo/_base/array dojo/has dojo/date/locale ../kernel ../numberUtils ../Color dojo/i18n!../nls/jsapi dojo/i18n!dojo/cldr/nls/gregorian".split(" "),function(k,n,e,d,g,t,u,a,m){function L(c){return c&&n.map(c,function(c){return new u(c)})}function F(c,a,d){var h="";0===a?h=B.lt+" ":a===d&&(h=B.gt+" ");return h+c}var y={},B={lte:"\x3c\x3d",gte:"\x3e\x3d",lt:"\x3c",gt:"\x3e",pct:"%"},q={millisecond:0,second:1,minute:2,hour:3,day:4,month:5,year:6},
c={millisecond:{dateOptions:{formatLength:"long"},timeOptions:{formatLength:"medium"}},second:{dateOptions:{formatLength:"long"},timeOptions:{formatLength:"medium"}},minute:{dateOptions:{formatLength:"long"},timeOptions:{formatLength:"short"}},hour:{dateOptions:{formatLength:"long"},timeOptions:{formatLength:"short"}},day:{selector:"date",dateOptions:{formatLength:"long"}},month:{selector:"date",dateOptions:{formatLength:"long"}},year:{selector:"date",dateOptions:{selector:"year"}}},x={formatLength:"short",
fullYear:!0},J={formatLength:"short"};k.mixin(y,{timelineDateFormatOptions:{selector:"date",dateOptions:{formatLength:"short",fullYear:!0}},formatDate:function(c,a){var h,e=[];null==c||c instanceof Date||(c=new Date(c));a=a||{};a=k.mixin({},a);var g=a.selector?a.selector.toLowerCase():null;h=!g||-1<g.indexOf("time");g=!g||-1<g.indexOf("date");h&&(a.timeOptions=a.timeOptions||J,a.timeOptions&&(a.timeOptions=k.mixin({},a.timeOptions),a.timeOptions.selector=a.timeOptions.selector||"time",e.push(a.timeOptions)));
g&&(a.dateOptions=a.dateOptions||x,a.dateOptions&&(a.dateOptions=k.mixin({},a.dateOptions),a.dateOptions.selector=a.dateOptions.selector||"date",e.push(a.dateOptions)));e&&e.length?(e=n.map(e,function(a){return d.format(c,a)}),h=1==e.length?e[0]:m["dateTimeFormat-medium"].replace(/\'/g,"").replace(/\{(\d+)\}/g,function(a,c){return e[c]})):h=d.format(c);return h},createColorStops:function(a){var c=a.values,d=a.colors,e=a.labelIndexes,h=a.isDate,g=a.dateFormatOptions;a=[];return a=n.map(c,function(a,
v){var k=null;if(!e||-1<n.indexOf(e,v)){var m;(m=h?y.formatDate(a,g):t.format(a))&&(k=F(m,v,c.length-1))}return{value:a,color:d[v],label:k}})},updateColorStops:function(a){var c=a.stops,d=a.changes,e=a.isDate,h=a.dateFormatOptions,g=[],k,m=n.map(c,function(a){return a.value});n.forEach(d,function(a){g.push(a.index);m[a.index]=a.value});k=t.round(m,{indexes:g});n.forEach(c,function(a,d){a.value=m[d];if(null!=a.label){var g,v=null;(g=e?y.formatDate(k[d],h):t.format(k[d]))&&(v=F(g,d,c.length-1));a.label=
v}})},createClassBreakLabel:function(c){var d=c.minValue,e=c.maxValue,h=c.isFirstBreak?"":B.gt+" ";c="percent-of-total"===c.normalizationType?B.pct:"";d=null==d?"":t.format(d);e=null==e?"":t.format(e);return h+d+c+" "+a.smartMapping.minToMax+" "+e+c},setLabelsForClassBreaks:function(a){var c=a.classBreaks,d=a.classificationMethod,e=a.normalizationType,h=[];c&&c.length&&("standard-deviation"===d?console.log("setLabelsForClassBreaks: cannot set labels for class breaks generated using 'standard-deviation' method."):
a.round?(h.push(c[0].minValue),n.forEach(c,function(a){h.push(a.maxValue)}),h=t.round(h),n.forEach(c,function(a,c){a.label=y.createClassBreakLabel({minValue:0===c?h[0]:h[c],maxValue:h[c+1],isFirstBreak:0===c,normalizationType:e})})):n.forEach(c,function(a,c){a.label=y.createClassBreakLabel({minValue:a.minValue,maxValue:a.maxValue,isFirstBreak:0===c,normalizationType:e})}))},updateClassBreak:function(a){var c=a.classBreaks,d=a.normalizationType,e=a.change,h=e.index,e=e.value,g=-1,k=-1,m=c.length;"standard-deviation"===
a.classificationMethod?console.log("updateClassBreak: cannot update labels for class breaks generated using 'standard-deviation' method."):(0===h?g=h:h===m?k=h-1:(k=h-1,g=h),-1<g&&g<m&&(a=c[g],a.minValue=e,a.label=y.createClassBreakLabel({minValue:a.minValue,maxValue:a.maxValue,isFirstBreak:0===g,normalizationType:d})),-1<k&&k<m&&(a=c[k],a.maxValue=e,a.label=y.createClassBreakLabel({minValue:a.minValue,maxValue:a.maxValue,isFirstBreak:0===k,normalizationType:d})))},calculateDateFormatInterval:function(a){var c,
d,e=a.length,h,g,k,m,u,t,x=Infinity,y;a=n.map(a,function(a){return new Date(a)});for(c=0;c<e-1;c++){h=a[c];k=[];u=Infinity;t="";for(d=c+1;d<e;d++)g=a[d],g=h.getFullYear()!==g.getFullYear()&&"year"||h.getMonth()!==g.getMonth()&&"month"||h.getDate()!==g.getDate()&&"day"||h.getHours()!==g.getHours()&&"hour"||h.getMinutes()!==g.getMinutes()&&"minute"||h.getSeconds()!==g.getSeconds()&&"second"||"millisecond",m=q[g],m<u&&(u=m,t=g),k.push(g);u<x&&(x=u,y=t)}return y},createUniqueValueLabel:function(a){var d=
a.value,e=a.fieldInfo,h=a.domain;a=a.dateFormatInterval;var g=String(d);(h=h&&h.codedValues?h.getName(d):null)?g=h:"number"===typeof d&&(g=e&&"esriFieldTypeDate"===e.type?y.formatDate(d,a&&c[a]):t.format(d));return g},cloneColorInfo:function(a){var c;a&&(c=k.mixin({},a),c.colors=L(c.colors),c.stops=c.stops&&n.map(c.stops,function(a){a=k.mixin({},a);a.color&&(a.color=new u(a.color));return a}),c.legendOptions&&(c.legendOptions=k.mixin({},c.legendOptions)));return c},cloneOpacityInfo:function(a){var c;
if(a){c=k.mixin({},a);if(a=c.opacityValues)c.opacityValues=a.slice(0);if(a=c.stops)c.stops=n.map(a,function(a){return k.mixin({},a)});if(a=c.legendOptions)c.legendOptions=k.mixin({},a)}return c},cloneSizeInfo:function(a){var c;a&&(c=k.mixin({},a),c.stops&&(c.stops=n.map(c.stops,function(a){return k.mixin({},a)})),(a=c.minSize)&&"object"===typeof a&&(c.minSize=y.cloneSizeInfo(a)),(a=c.maxSize)&&"object"===typeof a&&(c.maxSize=y.cloneSizeInfo(a)),a=c.legendOptions)&&(c.legendOptions=k.mixin({},a),a=
a.customValues)&&(c.legendOptions.customValues=a.slice(0));return c}});e("extend-esri")&&k.setObject("renderer.utils",y,g);return y})},"esri/dijit/_EventedWidget":function(){define("dojo/_base/declare dojo/_base/lang dojo/aspect dojo/on ../Evented dijit/_WidgetBase".split(" "),function(k,n,e,d,g,t){return k([t,g],{_onMap:function(d){var a=this.constructor._onMap,e;a&&a.FINAL||(delete this.constructor._onMap,a=this.registerConnectEvents(),a.FINAL=!0);d=d.toLowerCase();a[d]?e=this[a[d].method]:(d=this._onCamelCase(d),
this[d]&&(e=d));return e},on:function(e,a){var g=this._onMap(e),k=e.replace(/\-/g,""),n="on"+k in this.domNode;return g||!n?this.inherited(arguments):this.own(d(this.domNode,k,a))[0]},emit:function(d,a,e){var g,k,m,u=d.toLowerCase(),q=this.constructor._onMap||this.registerConnectEvents();k=this[this._onMap(u)];a=a||{};a.target||(a.target=this);k&&q&&q[u]&&(this._onObj2Arr(function(){g=Array.prototype.slice.call(arguments)},q[u].argKeys)(a),m=n.mixin({},arguments),m[2]=g,m[0]=q[u].name.replace(/^on/,
""));return this.inherited(m||arguments)}})})},"*noref":1}});
define("esri/dijit/Legend","dojo/_base/kernel dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/_base/connect dojo/_base/json dojo/_base/Color dojo/debounce dojo/has dojo/sniff dojo/Deferred dojo/DeferredList dojo/json dojo/dom dojo/dom-construct dojo/dom-style dojo/dom-class dijit/_Widget dojox/gfx dojox/gfx/matrix dojox/html/entities ../kernel ../config ../request ../lang ../numberUtils ../renderers/utils ../renderers/SimpleRenderer ../renderers/UniqueValueRenderer ../renderers/ClassBreaksRenderer ../renderers/ScaleDependentRenderer ../renderers/DotDensityRenderer ../renderers/TemporalRenderer ../renderers/VectorFieldRenderer ../renderers/HeatmapRenderer ../symbols/PictureFillSymbol ../symbols/SimpleLineSymbol ../symbols/jsonUtils ../renderers/jsonUtils ./_EventedWidget dojo/i18n!../nls/jsapi".split(" "),function(k,
n,e,d,g,t,u,a,m,L,F,y,B,q,c,x,J,h,v,H,D,Q,I,N,K,E,O,X,Y,Z,aa,ba,ca,R,da,T,U,P,V,W,S){var M=n([W,h],{declaredClass:"esri.dijit.Legend",widgetsInTemplate:!1,layers:null,alignRight:!1,hoverLabelShowing:!1,_preserveCacheOnDestroy:!1,dotDensitySwatchSize:26,dotCoverage:75,gradientHeight:30,transparencyRampColor:new u([64,64,64]),defaultText:"Aa",sizeRampLightColor:new u([255,255,255]),sizeRampDarkColor:new u([128,128,128]),layerConnects:[],gradientWidth:34,colorRampBorder:"1px solid",_specialChars:{lt:"\x3c",
gt:"\x3e"},_ieTimer:100,_isRightToLeft:!1,_align:null,_legendAlign:null,constructor:function(b,f){e.mixin(this,S.widgets.legend);this._i18n=S.widgets.legend;b=b||{};b.map?f?(this.map=b.map,this.layerInfos=b.layerInfos,this._respectCurrentMapScale=!1===b.respectCurrentMapScale?!1:!0,this._respectVisibility=!1===b.respectVisibility?!1:!0,this._preserveCacheOnDestroy=b.preserveCacheOnDestroy?!0:!1,this.arrangement=b.arrangement===M.ALIGN_RIGHT?M.ALIGN_RIGHT:M.ALIGN_LEFT,this.arrangement===M.ALIGN_RIGHT&&
(this.alignRight=!0),this.autoUpdate=!1===b.autoUpdate?!1:!0,this._surfaceItems=[],this.hideLayersInLegend={},this.refresh=a(this.refresh,0)):console.error("esri.dijit.Legend: must specify a container for the legend"):console.error("esri.dijit.Legend: unable to find the 'map' property in parameters")},postMixInProperties:function(){this.inherited(arguments);var b=["ar","he"],f,a;for(f=0;f<b.length;f+=1)a=b[f],k.locale&&-1!==k.locale.indexOf(a)&&(-1!==k.locale.indexOf("-")?-1!==k.locale.indexOf(a+
"-")&&(this._isRightToLeft=!0):this._isRightToLeft=!0);this._isRightToLeft?(this._align=this.alignRight?"left":"right",this._legendAlign=this.alignRight?"esriLegendLeft":"esriLegendRight"):(this._align=this.alignRight?"right":"left",this._legendAlign=this.alignRight?"esriLegendRight":"esriLegendLeft")},startup:function(){this.inherited(arguments);this._initialize();9>m("ie")&&(this._repaintItems=e.hitch(this,this._repaintItems),setTimeout(this._repaintItems,this._ieTimer))},destroy:function(){this._deactivate();
this._removeCachedLegendResponses();this._removeHoverHandlers();this.inherited(arguments)},_removeCachedLegendResponses:function(){this._preserveCacheOnDestroy||d.forEach(this.layers,function(b){delete b.legendResponse})},refresh:function(b){if(this.domNode){b?(this.layerInfos=b,this.layers=[],d.forEach(this.layerInfos,function(b){this._isSupportedLayerType(b.layer)&&(b.title&&(b.layer._titleForLegend=b.title),b.layer._hideDefaultSymbol=!1===b.defaultSymbol?!0:!1,b.hideLayers?(this.hideLayersInLegend[b.layer.id]=
b.hideLayers,this._addSubLayersToHide(b)):this.hideLayersInLegend[b.layer.id]=[],b.hoverLabel&&(b.layer._hoverLabel=b.hoverLabel),b.hoverLabels&&(b.layer._hoverLabels=b.hoverLabels),this.layers.push(b.layer))},this)):this.useAllMapLayers&&(this.layers=this.layerInfos=null);for(b=this.domNode.children.length-1;0<=b;b--)c.destroy(this.domNode.children[b]);this._removeHoverHandlers();this.startup()}},_legendUrl:"http://utility.arcgis.com/sharing/tools/legend",_initialize:function(){this.layerInfos&&
(this.layers=[],d.forEach(this.layerInfos,function(b){this._isSupportedLayerType(b.layer)&&(b.title&&(b.layer._titleForLegend=b.title),b.layer._hideDefaultSymbol=!1===b.defaultSymbol?!0:!1,b.hideLayers?(this.hideLayersInLegend[b.layer.id]=b.hideLayers,this._addSubLayersToHide(b)):this.hideLayersInLegend[b.layer.id]=[],b.hoverLabel&&(b.layer._hoverLabel=b.hoverLabel),b.hoverLabels&&(b.layer._hoverLabels=b.hoverLabels),this.layers.push(b.layer))},this));this.useAllMapLayers=!1;if(!this.layers){this.useAllMapLayers=
!0;this.layers=[];var b=[],f=[];d.forEach(this.map.layerIds,function(a){a=this.map.getLayer(a);var c;this._isSupportedLayerType(a)&&(a.arcgisProps&&a.arcgisProps.title&&(a._titleForLegend=a.arcgisProps.title),this.layers.push(a));"esri.layers.KMLLayer"==a.declaredClass&&(c=a.getLayers(),d.forEach(c,function(a){b.push(a.id)},this));"esri.layers.GeoRSSLayer"==a.declaredClass&&(c=a.getFeatureLayers(),d.forEach(c,function(b){f.push(b.id)},this))},this);d.forEach(this.map.graphicsLayerIds,function(a){var c=
this.map.getLayer(a);-1==d.indexOf(b,a)&&-1==d.indexOf(f,a)&&this._isSupportedLayerType(c)&&this._isLayerDrawingEnabled(c)&&(c.arcgisProps&&c.arcgisProps.title&&(c._titleForLegend=c.arcgisProps.title),this.layers.push(c))},this)}this._createLegend()},_isLayerDrawingEnabled:function(b){return b&&(b._params&&b._params.drawMode||b.isAggregationEnabled&&b.isAggregationEnabled())},_activate:function(){this._deactivate();this.autoUpdate&&(this._respectCurrentMapScale&&(this._ozeConnect=g.connect(this.map,
"onZoomEnd",this,"_refreshLayers")),this.useAllMapLayers&&(this._olaConnect=g.connect(this.map,"onLayerAdd",this,"_updateAllMapLayers"),this._olrConnect=g.connect(this.map,"onLayerRemove",this,"_updateAllMapLayers"),this._olroConnect=g.connect(this.map,"onLayersReordered",this,"_updateAllMapLayers")),d.forEach(this.layers,function(b){var a={};a.oarcConnect=g.connect(b,"onAggregationRendererChange",this,"_refreshLayers");a.oaicConnect=g.connect(b,"onAggregationInfoChange",this,"_refreshLayers");a.ovcConnect=
g.connect(b,"onVisibilityChange",this,"_refreshLayers");a.oocConnect=g.connect(b,"onOpacityChange",this,"_refreshLayers");a.oscConnect=g.connect(b,"onScaleRangeChange",this,"_refreshLayers");"esri.layers.ArcGISDynamicMapServiceLayer"===b.declaredClass&&b.supportsDynamicLayers&&(a.odcConnect=g.connect(b,"_onDynamicLayersChange",e.hitch(this,"_updateDynamicLayers",b)));"esri.layers.ArcGISImageServiceLayer"===b.declaredClass&&(a.oirConnect=g.connect(b,"onRenderingChange",e.partial(this._updateImageServiceLayers,
this,b)),a.oivrConnect=g.connect(b,"onRendererChange",e.partial(this._updateImageServiceLayers,this,b)));"esri.layers.ArcGISImageServiceVectorLayer"===b.declaredClass&&(a.oivrConnect=g.connect(b,"onRendererChange",e.hitch(this,"_refreshLayers")));this.layerConnects[b.id]=a},this))},_deactivate:function(){this._ozeConnect&&g.disconnect(this._ozeConnect);this._olaConnect&&g.disconnect(this._olaConnect);this._olroConnect&&g.disconnect(this._olroConnect);this._olrConnect&&g.disconnect(this._olrConnect);
d.forEach(this.layers,function(b){b=this.layerConnects[b.id]||{};b.oarcConnect&&g.disconnect(b.oarcConnect);b.oaicConnect&&g.disconnect(b.oaicConnect);b.ovcConnect&&g.disconnect(b.ovcConnect);b.oocConnect&&g.disconnect(b.oocConnect);b.oscConnect&&g.disconnect(b.oscConnect);b.odcConnect&&g.disconnect(b.odcConnect);b.oirConnect&&g.disconnect(b.oirConnect);b.oivrConnect&&g.disconnect(b.oivrConnect)},this);this.layerConnects=[]},_updateDynamicLayers:function(b){delete b.legendResponse;this._refreshLayers()},
_updateImageServiceLayers:function(b,a){delete a.legendResponse;b._refreshLayers()},_refreshLayers:function(){this.refresh()},_updateAllMapLayers:function(){this.layers=[];d.forEach(this.map.layerIds,function(b){b=this.map.getLayer(b);this._isSupportedLayerType(b)&&this.layers.push(b)},this);d.forEach(this.map.graphicsLayerIds,function(b){b=this.map.getLayer(b);this._isSupportedLayerType(b)&&this._isLayerDrawingEnabled(b)&&this.layers.push(b)},this);this.refresh()},_createLegend:function(){var b=
!1,a=!1;x.set(this.domNode,"position","relative");c.create("div",{id:this.id+"_msg",className:"esriLegendMsg",innerHTML:this.NLS_creatingLegend+"..."},this.domNode);var l=[];d.forEach(this.layers,function(f){if("esri.layers.KMLLayer"==f.declaredClass||"esri.layers.GeoRSSLayer"==f.declaredClass){var r;f.loaded?("esri.layers.KMLLayer"==f.declaredClass?r=f.getLayers():"esri.layers.GeoRSSLayer"==f.declaredClass&&(r=f.getFeatureLayers(),this.hideLayersInLegend[f.id]&&(r=d.filter(r,function(b){return-1==
d.indexOf(this.hideLayersInLegend[f.id],b.id)},this))),d.forEach(r,function(b){"esri.layers.FeatureLayer"==b.declaredClass&&f._titleForLegend&&(b._titleForLegend=f._titleForLegend+" - ","esriGeometryPoint"==b.geometryType?b._titleForLegend+=this.NLS_points:"esriGeometryPolyline"==b.geometryType?b._titleForLegend+=this.NLS_lines:"esriGeometryPolygon"==b.geometryType&&(b._titleForLegend+=this.NLS_areas),l.push(b))},this)):g.connect(f,"onLoad",e.hitch(this,function(){this.refresh(this.layerInfos)}))}else if("esri.layers.WMSLayer"===
f.declaredClass)if(!f.loaded)g.connect(f,"onLoad",e.hitch(this,function(){this.refresh(this.layerInfos)}));else{if((!this._respectVisibility||this._respectVisibility&&f.visible)&&0<f.layerInfos.length&&d.some(f.layerInfos,function(b){return b.legendURL})){var w=!1;d.forEach(f.layerInfos,function(a){if(a.legendURL&&-1<d.indexOf(f.visibleLayers,a.name)){w||(c.create("div",{innerHTML:"\x3cspan class\x3d'esriLegendServiceLabel'\x3e"+(f._titleForLegend||f.name||f.id)+"\x3c/span\x3e"},this.domNode),w=!0);
var l;a=a.legendURL;if(f.customParameters||f.customLayerParameters){var r=e.clone(f.customParameters||{});e.mixin(r,f.customLayerParameters||{});for(l in r)a+=(-1===a.indexOf("?")?"?":"\x26")+l+"\x3d"+r[l]}c.create("div",{innerHTML:"\x3cimg src\x3d'"+a+"'/\x3e"},this.domNode);b=!0}},this)}}else"esri.layers.WFSLayer"!==f.declaredClass||f.renderer?l.push(f):(r=c.create("div",{id:this.id+"_"+f.id,"class":"esriLegendService"}),c.create("span",{innerHTML:this._getServiceTitle(f),"class":"esriLegendServiceLabel"},
c.create("td",{align:this._align},c.create("tr",{},c.create("tbody",{},c.create("table",{width:"95%"},r))))),c.place(r,this.id,"first"),r=c.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},r),r=c.create("tbody",{},r),"esriGeometryComplex"===f.geometryType?(this._buildRow_Renderer(f,f._pointSymbol,null,this.NLS_points,null,r),this._buildRow_Renderer(f,f._lineSymbol,null,this.NLS_lines,null,r),this._buildRow_Renderer(f,f._polygonSymbol,null,this.NLS_areas,null,r)):
"esriGeometryPoint"===f.geometryType?this._buildRow_Renderer(f,f._pointSymbol,null,"",null,r):"esriGeometryPolyline"===f.geometryType?this._buildRow_Renderer(f,f._lineSymbol,null,"",null,r):"esriGeometryPolygon"===f.geometryType&&this._buildRow_Renderer(f,f._polygonSymbol,null,"",null,r),a=!0)},this);var r=[];d.forEach(l,function(b){if(!b.loaded)var a=g.connect(b,"onLoad",this,function(b){g.disconnect(a);a=null;this.refresh()});else if((!this._respectVisibility||this._respectVisibility&&b.visible)&&
(b.layerInfos||b.renderer||"esri.layers.ArcGISImageServiceLayer"==b.declaredClass)){var f=c.create("div",{id:this.id+"_"+b.id,style:{display:"none"},"class":"esriLegendService"});c.create("span",{innerHTML:this._getServiceTitle(b),"class":"esriLegendServiceLabel"},c.create("td",{align:this._align},c.create("tr",{},c.create("tbody",{},c.create("table",{width:"95%"},f)))));c.place(f,this.id,"first");b.legendResponse||b.renderer&&"esri.renderer.StretchRenderer"!==b.renderer.declaredClass?this._createLegendForLayer(b):
this.isHostedTileService(b)?this._getLayerInfos(b).then(e.hitch(this,function(b){this._createLegendForLayer(b)}),e.hitch(this,function(b){r.push(this._legendRequest(b))})):r.push(this._legendRequest(b))}},this);0!==r.length||b||a?(new y(r)).addCallback(e.hitch(this,function(f){b||a?q.byId(this.id+"_msg").innerHTML="":q.byId(this.id+"_msg").innerHTML=this.NLS_noLegend;this._activate()})):(q.byId(this.id+"_msg").innerHTML=this.NLS_noLegend,this._activate())},_createLegendForLayer:function(b){if(b.legendResponse||
b.renderer||this.isHostedTileService(b)){var a=!1;if(b.legendResponse||this.isHostedTileService(b)){var c=b.dynamicLayerInfos||b.layerInfos;c&&c.length?d.forEach(c,function(f,c){if(!this.hideLayersInLegend[b.id]||-1===d.indexOf(this.hideLayersInLegend[b.id],f.id)){var l=this._buildLegendItems(b,f,c);a=a||l}},this):"esri.layers.ArcGISImageServiceLayer"==b.declaredClass&&(a=this._buildLegendItems(b,{id:0,name:null,title:b.name,subLayerIds:null,parentLayerId:-1},0))}else b.renderer&&(c=b.url?b.url.substring(b.url.lastIndexOf("/")+
1,b.url.length):"fc_"+b.id,a=this._buildLegendItems(b,{id:c,name:null,subLayerIds:null,parentLayerId:-1},0));a&&(x.set(q.byId(this.id+"_"+b.id),"display","block"),x.set(q.byId(this.id+"_msg"),"display","none"))}},_legendRequest:function(b){if(b.loaded)return 10.01<=b.version?this._legendRequestServer(b):this._legendRequestTools(b);g.connect(b,"onLoad",e.hitch(this,"_legendRequest"))},_legendRequestServer:function(b){var a=b.url,c=a.indexOf("?"),a=-1<c?a.substring(0,c)+"/legend"+a.substring(c):a+"/legend";
(c=b._getToken())&&(a+="?token\x3d"+c);var r=e.hitch(this,"_processLegendResponse"),w={f:"json"};b._params.dynamicLayers&&(w.dynamicLayers=B.stringify(this._createDynamicLayers(b)),"[{}]"===w.dynamicLayers&&(w.dynamicLayers="[]"));b._params.bandIds&&(w.bandIds=b._params.bandIds);b._params.renderingRule?w.renderingRule=b._params.renderingRule:b.rasterFunctionInfos&&0<b.rasterFunctionInfos.length&&d.forEach(b.rasterFunctionInfos,function(b){b&&b.name&&"none"===b.name.toLowerCase()&&(w.renderingRule=
B.stringify({rasterFunction:b.name}))});return N({url:a,content:w,callbackParamName:"callback",load:function(a,f){r(b,a,f)},error:I.defaults.io.errorHandler})},_legendRequestTools:function(b){var a=b.url.toLowerCase().indexOf("/rest/"),a=b.url.substring(0,a)+b.url.substring(a+5,b.url.length),a=this._legendUrl+"?soapUrl\x3d"+window.escape(a);if(!m("ie")||8<m("ie"))a+="\x26returnbytes\x3dtrue";var c=e.hitch(this,"_processLegendResponse");return N({url:a,content:{f:"json"},callbackParamName:"callback",
load:function(a,f){c(b,a,f)},error:I.defaults.io.errorHandler})},_processLegendResponse:function(b,a){a&&a.layers?(b.legendResponse=a,q.byId(this.id+"_"+b.id)&&c.empty(q.byId(this.id+"_"+b.id)),c.create("span",{innerHTML:this._getServiceTitle(b),"class":"esriLegendServiceLabel"},c.create("td",{align:this._align},c.create("tr",{},c.create("tbody",{},c.create("table",{width:"95%"},q.byId(this.id+"_"+b.id)))))),this._createLegendForLayer(b)):console.log("Legend could not get generated for "+b.url+": "+
t.toJson(a))},_buildLegendItems:function(b,a,l){var f=!1,e=q.byId(this.id+"_"+b.id),z=a.parentLayerId;if(a.subLayerIds)b=c.create("div",{id:this.id+"_"+b.id+"_"+a.id+"_group",style:{display:"none"},"class":-1==z?0<l?"esriLegendGroupLayer":"":this._legendAlign},-1==z?e:q.byId(this.id+"_"+b.id+"_"+z+"_group")),c.create("td",{innerHTML:D.encode(a.name),align:this._align},c.create("tr",{},c.create("tbody",{},c.create("table",{width:"95%","class":"esriLegendLayerLabel"},b))));else{if(this._respectVisibility&&
b.visibleLayers)if(l=b.dynamicLayerInfos||b.layerInfos)if(b._params&&b._params.layers){if(-1===d.indexOf(b.visibleLayers,a.id))return f}else{if(l=this._getReallyVisibleLayers(l,b.visibleLayers),-1===d.indexOf(l,a.id))return f}else if(-1===d.indexOf(b.visibleLayers,a.id))return f;e=c.create("div",{id:this.id+"_"+b.id+"_"+a.id,style:{display:"none"},"class":-1<z?this._legendAlign:""},-1==z?e:q.byId(this.id+"_"+b.id+"_"+z+"_group"));c.create("td",{innerHTML:D.encode(a.name)||"",align:this._align},c.create("tr",
{},c.create("tbody",{},c.create("table",{width:"95%","class":"esriLegendLayerLabel"},e))));l=b.dynamicLayerInfos||b.layerInfos;z=!1;l&&l.length&&(z=d.some(l,function(b){return!!b.drawingInfo}));if(b.legendResponse)f=f||this._buildLegendItems_Tools(b,a,e);else if(b.renderer||z)f=f||this._buildLegendItems_Renderer(b,a,e)}return f},_getReallyVisibleLayers:function(b,a){if(!b||!a||!a.length)return[];var f=[],c=[],e;for(e=0;e<b.length;e++)if(b[e].subLayerIds){if(-1===d.indexOf(a,b[e].id)||-1<d.indexOf(c,
b[e].id))c=c.concat(b[e].subLayerIds)}else-1<d.indexOf(a,b[e].id)&&-1===d.indexOf(c,b[e].id)&&f.push(b[e].id);return f},_buildLegendItems_Tools:function(b,a,l){var f=a.parentLayerId,e=this.map.getScale(),z=!1,g=function(b,a){var f,c;for(f=0;f<b.length;f++)if(a.dynamicLayerInfos)for(c=0;c<a.dynamicLayerInfos[c].length;c++){if(a.dynamicLayerInfos[c].mapLayerId==b[f].layerId)return b[f]}else if(a.id==b[f].layerId)return b[f];return{}};if(!this._respectCurrentMapScale||this._respectCurrentMapScale&&this._isLayerInScale(b,
a,e)){var h=!0;if(this._respectCurrentMapScale&&("esri.layers.ArcGISDynamicMapServiceLayer"===b.declaredClass||"esri.layers.ArcGISMapServiceLayer"===b.declaredClass)){var k=this._getEffectiveScale(b,a);if(k.minScale&&k.minScale<e||k.maxScale&&k.maxScale>e)h=!1}if(h){var e=g(b.legendResponse.layers,a),C=e.legendType,p=e.layerType,m=e.legend;if(m){"esri.layers.ArcGISImageServiceLayer"!==b.declaredClass&&this._sanitizeLegendResponse(b,e,a);l=c.create("table",{cellpadding:0,cellspacing:0,width:"95%",
"class":"esriLegendLayer"},l);var n=c.create("tbody",{},l);(b._hoverLabel||b._hoverLabels)&&this._createHoverAction(l,b,a);d.forEach(m,function(f){if(!(10.1<=b.version&&!f.values&&1<m.length)||!b._hideDefaultSymbol&&"\x3call other values\x3e"!==f.label&&(f.label||"esri.layers.ArcGISImageServiceLayer"===b.declaredClass&&10.3<=b.version||"Raster Layer"===p))if(f.url&&0===f.url.indexOf("http")||f.imageData&&0<f.imageData.length)z=!0,this._buildRow_Tools(f,n,b,a.id,C)},this)}}}z&&(x.set(q.byId(this.id+
"_"+b.id+"_"+a.id),"display","block"),-1<f&&(x.set(q.byId(this.id+"_"+b.id+"_"+f+"_group"),"display","block"),this._findParentGroup(b.id,b,f)));return z},_getLayerInfos:function(b){var a=new F,c=b.dynamicLayerInfos||b.layerInfos;if(c&&c.length)if(d.some(c,function(b){return!!b.drawingInfo}))a.resolve(b);else{var e=b.url,w=e.indexOf("?"),e=-1==w?e+"/layers":e.substring(0,w)+"/layers"+e.substring(w,e.length);N({url:e,content:{f:"json"},callbackParamName:"callback",load:function(f,e){f.layers?(d.forEach(c,
function(b){var a=d.filter(f.layers,function(a){return b.source?a.id===b.source.mapLayerId:a.id===b.id});a&&a[0]&&a[0].drawingInfo&&(b.drawingInfo=a[0].drawingInfo,b.fields=a[0].fields)}),a.resolve(b)):a.reject(b)},error:function(f){a.reject(b)}})}return a},_sanitizeLegendResponse:function(b,a,c){var f=a.legend;if(10.1<=b.version&&1<f.length&&!a._sanitized){b=e.getObject("layerDefinition.drawingInfo.renderer",!1,c);var l,z;b||(b=e.getObject("drawingInfo.renderer",!1,c));d.some(f,function(b){if(b.values)return!0})&&
d.some(f,function(b,a){b.values||(z=a,l=b);return!!l});b?"uniqueValue"===b.type?l&&(f.splice(z,1),f.push(l)):"classBreaks"===b.type&&(l&&f.splice(z,1),f.reverse(),l&&f.push(l)):l&&(f.splice(z,1),f.push(l));a._sanitized=!0}},_buildRow_Tools:function(b,a,l,e,d){var f=c.create("tr",{},a),r;this.alignRight?(a=c.create("td",{align:this._isRightToLeft?"left":"right"},f),r=c.create("td",{align:this._isRightToLeft?"left":"right",width:35},f)):(r=c.create("td",{width:35,align:"center"},f),a=c.create("td",
{},f));f=b.url;(!m("ie")||9<=m("ie")||9>m("ie")&&"esri.layers.ArcGISImageServiceLayer"===l.declaredClass)&&b.imageData&&0<b.imageData.length?f="data:image/png;base64,"+b.imageData:0!==b.url.indexOf("http")&&(f=l.url+"/"+e+"/images/"+b.url,(e=l._getToken())&&(f+="?token\x3d"+e));e=c.create("img",{src:f,border:0,style:"opacity:"+l.opacity},r);b=c.create("td",{innerHTML:D.encode(b.label),align:this._align},c.create("tr",{},c.create("tbody",{},c.create("table",{width:"95%",dir:"ltr"},a))));d&&"Stretched"===
d&&10.3<=l.version&&"esri.layers.ArcGISImageServiceLayer"===l.declaredClass&&(b.style.verticalAlign="top",b.style.lineHeight="1",e.style.marginBottom="-1px",e.style.display="block",a.style.verticalAlign="top");9>m("ie")&&(e.style.filter="alpha(opacity\x3d"+100*l.opacity+")")},_getVariable:function(b,a,c){var f;b&&(f=(b=b.getVisualVariablesForType(a,c))&&b[0]);return f},_getVariables:function(b,a,c){b=[this._getVariable(b,"colorInfo",!1),this._getVariable(b,"opacityInfo",!1),this._getVariable(b,"sizeInfo",
!1)];return a?d.filter(b,function(b){return!(!b||b.field!==a||b.normalizationField!=c)}):b},_getFieldAlias:function(b,a,c){var f=a.infoTemplate||(a.infoTemplates&&c&&a.infoTemplates[c.id]?a.infoTemplates[c.id].infoTemplate:null),f=f&&f.getFieldInfo&&f.getFieldInfo(b);b=e.isFunction(b)?null:this.getField(a,b,c);a=f||b;c="";a&&(c=f&&f.label||b&&b.alias||a.name||a.fieldName);return c},_getRampTitle:function(b,a,c){var f,d=b.field,l=b.normalizationField,g=!1,h=!1,k=!1,d=e.isFunction(d)?null:d,l=e.isFunction(l)?
null:l;if(b.legendOptions&&b.legendOptions.title)f=b.legendOptions.title;else if(b.valueExpressionTitle)f=b.valueExpressionTitle;else{if(a.renderer&&a.renderer.authoringInfo&&a.renderer.authoringInfo.visualVariables){var C=a.renderer.authoringInfo.visualVariables;for(b=0;b<C.length;b++){var p=C[b];if("colorInfo"===p.type&&"ratio"===p.style){g=!0;break}else if("colorInfo"===p.type&&"percent"===p.style){h=!0;break}else if("colorInfo"===p.type&&"percentTotal"===p.style){k=!0;break}}}(g=k&&"showRatioPercentTotal"||
h&&"showRatioPercent"||g&&"showRatio"||l&&"showNormField"||d&&"showField"||null)&&(f=K.substitute({field:d&&this._getFieldAlias(d,a,c),normField:l&&this._getFieldAlias(l,a,c)},this._i18n[g]))}return f},_getRendererTitle:function(b,a,c){var f;if(b){var d,l,g;"esri.renderer.ClassBreaksRenderer"===b.declaredClass&&(d=b.attributeField,l=b.normalizationField,g="percent-of-total"===b.normalizationType);d=e.isFunction(d)?null:d;l=e.isFunction(l)?null:l;b.legendOptions&&b.legendOptions.title?f=b.legendOptions.title:
b.valueExpressionTitle?f=b.valueExpressionTitle:(b=l&&"showNormField"||(g?"showNormPct":null)||d&&"showField"||null)&&(f=K.substitute({field:d&&this._getFieldAlias(d,a,c),normField:l&&this._getFieldAlias(l,a,c)},this._i18n[b]))}return f},_buildLegendItems_Renderer:function(b,a,l){var f=a.parentLayerId,w=this.map,g=w.getScale(),h,k=!1;if(!this._respectCurrentMapScale||this._isLayerInScale(b,a,g)){var A,C,p,m,n,u,t,v;p="esri.layers.ArcGISImageServiceVectorLayer"===b.declaredClass?b.renderer.renderer:
a&&a.drawingInfo?V.fromJson(e.clone(a.drawingInfo.renderer)):b.isAggregationEnabled&&b.isAggregationEnabled()?b.getAggregationRenderer():b.renderer;if("esri.renderer.ScaleDependentRenderer"===p.declaredClass&&(p=(p="zoom"===p.rangeType?p.getRendererInfoByZoom(w.getZoom()):p.getRendererInfoByScale(g))&&p.renderer,!p))return!1;var G=this._getVariables(p),y=d.filter(G,function(b){return!!b}).length,g=G[0],w=G[1],G=G[2],B,E,F,H,I;g&&(m=this._getMedianColor(p,g),g.field&&(u=e.isFunction(g.field)?null:
this.getField(b,g.field,a)),B=!(g.legendOptions&&!1===g.legendOptions.showLegend));w&&(w.field&&(v=e.isFunction(w.field)?null:this.getField(b,w.field,a)),E=!(w.legendOptions&&!1===w.legendOptions.showLegend));G&&(G.field&&(t=e.isFunction(G.field)?null:this.getField(b,G.field,a)),F=!(G.legendOptions&&!1===G.legendOptions.showLegend));if("esri.renderer.HeatmapRenderer"===p.declaredClass)h=k=!0,this._showHeatRamp(b,a,p,l);else if("esri.renderer.DotDensityRenderer"===p.declaredClass)h=k=!0,this._showDotDensityLegend(b,
a,p,l);else if("esri.renderer.TemporalRenderer"===p.declaredClass)h=k=!0,C=c.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},l),A=c.create("tbody",{},C),(b._hoverLabel||b._hoverLabels)&&this._createHoverAction(C,b,a),p.latestObservationRenderer&&"esri.renderer.SimpleRenderer"===p.latestObservationRenderer.declaredClass&&this._buildRow_Renderer(b,p.latestObservationRenderer.symbol,m,D.encode(p.latestObservationRenderer.label)||this.NLS_currentObservations,null,A),
p.observationRenderer&&"esri.renderer.SimpleRenderer"===p.observationRenderer.declaredClass&&this._buildRow_Renderer(b,p.observationRenderer.symbol,m,D.encode(p.observationRenderer.label)||this.NLS_previousObservations,null,A);else if("esri.renderer.UniqueValueRenderer"===p.declaredClass){if(p.infos&&0<p.infos.length){h=k=!0;if(p.legendOptions&&p.legendOptions.title||p.valueExpressionTitle)C=c.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},l),A=c.create("tbody",
{},C),y=p.legendOptions&&p.legendOptions.title?p.legendOptions.title:p.valueExpressionTitle,this._buildRow_Renderer(b,null,m,D.encode(y),null,A);C=c.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},l);A=c.create("tbody",{},C);(b._hoverLabel||b._hoverLabels)&&this._createHoverAction(C,b,a);p.attributeField&&G&&this._addSubHeader(A,this._getFieldAlias(p.attributeField,b,a));var J=[];d.forEach(p.infos,function(a){var f=null;b._editable&&b.types&&(f=this._getTemplateFromTypes(b.types,
a.value));var c=a.label;null==c&&(c=a.value);-1===d.indexOf(J,c)&&(J.push(c),this._buildRow_Renderer(b,a.symbol,m,D.encode(c),f,A))},this)}I=this._displayDefaultSymbol(b,p,l)}else if("esri.renderer.ClassBreaksRenderer"===p.declaredClass){if(p.infos&&0<p.infos.length||"esri.layers.ArcGISImageServiceVectorLayer"===b.declaredClass)h=k=!0,H=this._isUnclassedRenderer(p),g||1!==p.infos.length||(n=(n=p.infos[0])&&n.symbol),H||(C=c.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},
l),A=c.create("tbody",{},C),y=this._getRendererTitle(p,b,a),this._buildRow_Renderer(b,null,m,D.encode(y),null,A)),C=c.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},l),A=c.create("tbody",{},C),(b._hoverLabel||b._hoverLabels)&&this._createHoverAction(C,b,a),H&&G&&F||(y=p.infos.slice(0).reverse(),d.forEach(y,function(a){var c=a.label;null!=c||H||(c=a.minValue+" - "+a.maxValue);this._buildRow_Renderer(b,a.symbol,m,D.encode(c),null,A)},this)),"esri.layers.ArcGISImageServiceVectorLayer"!==
b.declaredClass||b.renderer.style!==R.STYLE_SCALAR&&b.renderer.style!==R.STYLE_SINGLE_ARROW||(this._buildRow_Renderer(b,p.defaultSymbol,null,"",null,A),b._hideDefaultSymbol=!0);H||(I=this._displayDefaultSymbol(b,p,l))}else"esri.renderer.SimpleRenderer"===p.declaredClass&&(h=k=!0,C=c.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},l),A=c.create("tbody",{},C),(b._hoverLabel||b._hoverLabels)&&this._createHoverAction(C,b,a),n=null,b._editable&&b.templates&&0<b.templates.length&&
(n=b.templates[0]),C=1<y?null:u&&B||v&&E||t&&F,this._buildRow_Renderer(b,p.symbol,m,D.encode(C?this._getRampTitle(1<y?null:g||w||G,b,a):p.label),n,A),n=g?null:p.symbol,C&&(u=v=t=null));h&&(g&&B&&(g.field||g.valueExpression)&&this._showGradientRamp(b,a,p,null,l,g,u,null,G&&F?!0:!1),G&&F&&(G.field||G.valueExpression)&&(h=g&&B||"esri.renderer.UniqueValueRenderer"===p.declaredClass?!1:!0,this._showSizeLegend(b,a,p,G,m,l,t,null,h)),w&&E&&(w.field||w.valueExpression)&&this._showGradientRamp(b,a,p,n&&!n.url&&
n.color?n.color:this.transparencyRampColor,l,w,v,null,!1));I||H&&!B&&!F&&!E||(I=this._displayDefaultSymbol(b,p,l));k=k||I}k&&(x.set(q.byId(this.id+"_"+b.id+"_"+a.id),"display","block"),-1<f&&(x.set(q.byId(this.id+"_"+b.id+"_"+f+"_group"),"display","block"),this._findParentGroup(b.id,f)));return k},_isUnclassedRenderer:function(b,a){var c;if("esri.renderer.ClassBreaksRenderer"===b.declaredClass&&b.infos&&1===b.infos.length){c=b.attributeField;var f=b.normalizationField;c=a?c===a:!!this._getVariables(b,
c,f).length}return c},_displayDefaultSymbol:function(b,a,d){var f;!b._hideDefaultSymbol&&a.defaultSymbol&&(f=!0,d=c.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},d),d=c.create("tbody",{},d),this._buildRow_Renderer(b,a.defaultSymbol,null,D.encode(a.defaultLabel)||"others",null,d));return f},_showGradientRamp:function(b,a,d,r,g,h,k,m,A){A=c.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"+(A?"":" esriLegendSubFragment")},g);g=c.create("tbody",
{},A);(b._hoverLabel||b._hoverLabels||m)&&this._createHoverAction(A,b,a,m);(k||h.valueExpression||h.legendOptions&&h.legendOptions.title)&&this._addSubHeader(g,this._getRampTitle(h,b,a));k=h.field;var f;k&&(f=e.isFunction(k)?null:this.getField(b,k,a));(a=this._getRampStops(d,h,r,f&&"esriFieldTypeDate"===f.type))&&a.length&&this._drawGradientRamp(g,a,!0,b,this._getRampBorderColor(d),!!r)},_getMedianColor:function(b,a){var c,f;a.colors?(c=a.minDataValue,f=a.maxDataValue):a.stops&&(c=a.stops[0].value,
f=a.stops[a.stops.length-1].value);return b.getColor(c+(f-c)/2,{colorInfo:a})},_getRampStops:function(b,a,c,e){var f,l,g,r,h=!1;a.colors||a.opacityValues?(l=a.maxDataValue-a.minDataValue,f=d.map([0,.25,.5,.75,1],function(b){g=a.minDataValue+b*l;return Number(g.toFixed(6))}),this._checkPrecision(0,4,f)):a.stops&&(f=d.map(a.stops,function(b){return b.value}),(h=d.some(a.stops,function(b){return!!b.label}))&&(r=d.map(a.stops,function(b){return b.label})));var k=f[0],p,m;l=f[f.length-1]-k;return d.map(f,
function(d,g){c?(p=new u(c.toRgba()),m=b.getOpacity(d,{opacityInfo:a}),null!=m&&(p.a=m)):p=b.getColor(d,{colorInfo:a});var w="";if(h)w=r[g];else{var w=e?O.formatDate(d,O.timelineDateFormatOptions):E.format(d),z="";0===g?z=this._specialChars.lt+" ":g===f.length-1&&(z=this._specialChars.gt+" ");w=z+w}return{value:d,color:p,offset:1-(d-k)/l,label:w}},this).reverse()},_checkPrecision:function(b,a,c){var f=b+(a-b)/2,d=c[b],e=c[f],l=c[a],g=Math.floor(d),h=Math.floor(e),k=Math.floor(l);g===d&&k===l&&h!==
e&&g!==h&&k!==h&&(c[f]=h);b+1!==f&&this._checkPrecision(b,f,c);f+1!==a&&this._checkPrecision(f,a,c)},_getRampBorderColor:function(b){var a;if("esri.renderer.SimpleRenderer"===b.declaredClass)a=b.symbol;else if("esri.renderer.UniqueValueRenderer"===b.declaredClass||"esri.renderer.ClassBreaksRenderer"===b.declaredClass)a=b.infos[0].symbol;return(b=a&&-1===a.type.indexOf("linesymbol")?a.getStroke():null)&&b.color},_drawGradientRamp:function(b,a,e,g,h,k){var f=c.create("tr",{},b),l,r,w,p,z,n=a.length-
1,q;p=0;this.alignRight?(b=c.create("td",{align:this._isRightToLeft?"left":"right"},f),l=c.create("td",{align:this._isRightToLeft?"left":"right",width:this.gradientWidth},f)):(l=c.create("td",{width:this.gradientWidth,align:"center"},f),b=c.create("td",{},f));f=h&&0<h.a&&!(240<=h.r&&240<=h.g&&240<=h.b);r=c.create("div",{"class":f?"":"esriLegendBorderLessColorRamp",style:"position: relative; width:"+this.gradientWidth+"px;"},l);l=c.create("div",{"class":"esriLegendColorRamp"+(k?" esriLegendTransparencyRamp":
"")},r);k=x.get(l,"width");f&&(h=9>m("ie")?h.toHex():"rgba("+h.toRgba().join(",")+")",x.set(l,"border",this.colorRampBorder+" "+h));e?(h=this.gradientHeight*n,x.set(l,"height",h+"px")):h=x.get(l,"height");x.set(r,"height",h+"px");f=v.createSurface(l,k,h);9>m("ie")&&(p=f.getEventSource(),x.set(p,"position","relative"),x.set(p.parentNode,"position","relative"),p=1);try{e&&d.forEach(a,function(b,a){b.offset=a/n}),z=f.createRect({x:-p,y:-p,width:k+p,height:h+p}),z.setFill({type:"linear",x1:0,y1:0,x2:0,
y2:h,colors:a}).setStroke(null),f.createRect({width:k,height:h}).setFill(new u([255,255,255,1-g.opacity])).setStroke(null),this._surfaceItems.push(f)}catch(ea){f.clear(),f.destroy()}d.forEach(a,function(b,f){if(b.label){q="top:"+100*b.offset+"%;";var d="";0===f&&(d+=" esriLegendColorRampTickFirst");f===a.length-1&&(d+=" esriLegendColorRampTickLast");c.create("div",{"class":"esriLegendColorRampTick"+d,innerHTML:"\x26nbsp;",style:q},r)}});w=c.create("div",{"class":"esriLegendColorRampLabels",style:{height:h+
this.gradientHeight+"px"}},b);e?d.forEach(a,function(b){c.create("div",{"class":"esriLegendColorRampLabel",innerHTML:D.encode(b.label)||"\x26nbsp;"},w)}):(c.create("div",{"class":"esriLegendColorRampLabel",innerHTML:this._i18n.high},w),c.create("div",{"class":"esriLegendColorRampLabel",innerHTML:this._i18n.low,style:"top: "+(h+this.gradientHeight-2*this.gradientHeight)+"px;"},w))},_showHeatRamp:function(b,a,d,e,g){var f,l=d.field;f=c.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},
e);e=c.create("tbody",{},f);(b._hoverLabel||b._hoverLabels||g)&&this._createHoverAction(f,b,a,g);(l=l&&this.getField(b,l,a))&&this._addSubHeader(e,this._getFieldAlias(l.name,b,a));a=this._getHeatmapStops(d);a.length&&this._drawGradientRamp(e,a,!1,b)},_getHeatmapStops:function(b){var a=b.colorStops;b=b.colors;var c,e,g,h;a&&a[0]?(c=a.length-1,(b=a[0]&&null!=a[0].ratio)?(b=a[c])&&1!==b.ratio&&(a=a.slice(0),a.push({ratio:1,color:b.color}),c++):(e=a[0].value,g=a[c].value-e,a=d.map(a,function(b){return{color:b.color,
ratio:(b.value-e)/g}}))):b&&b[0]&&(c=b.length-1,h=1/(b.length-1),a=d.map(b,function(b,a){return{color:b,ratio:a*h}}));a=d.map(a,function(b,a){var f="";0===a?f="Low":a===c&&(f="High");return{color:b.color,label:f,offset:1-b.ratio}});return a.reverse()},_showDotDensityLegend:function(b,a,l,g){var f=l.legendOptions,h,r,k,m,n,p,u,q=this.dotDensitySwatchSize,t=Math.round(q/2);f&&(r=f.backgroundColor,k=f.outline,m=f.valueUnit,n=f.dotCoverage);n=(n||this.dotCoverage)/100;u=Math.round(q*q/Math.pow(l.dotSize,
2)*n);g=c.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},g);p=c.create("tbody",{},g);(b._hoverLabel||b._hoverLabels)&&this._createHoverAction(g,b,a);this._addSubHeader(p,K.substitute({value:l.dotValue,unit:m||""},this.NLS_dotValue));d.forEach(l.fields,function(c){c=e.mixin({},c);c.numPoints=u;h=new T(l._generateImageSrc(q,q,[c],{x:0,y:0},{x:q,y:q},r),k||l.outline,q,q);c=this.getField(b,c.name,a)||c;this._buildRow_Renderer(b,h,null,D.encode(this._getFieldAlias(c.name,
b,a)),null,p,{type:"path",path:"M "+-t+","+-t+" L "+t+","+-t+" L "+t+","+t+" L "+-t+","+t+" L "+-t+","+-t+" E"})},this)},_showSizeLegend:function(b,a,d,g,h,k,m,n,A){var f=g.legendOptions,f=f&&f.customValues;h=this._getSizeSymbol(d,h);if((!g.valueUnit||"unknown"===g.valueUnit)&&h&&(f||null!=g.minSize&&null!=g.maxSize&&null!=g.minDataValue&&null!=g.maxDataValue||g.stops&&!(1>=g.stops.length))){A=c.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"+(A?"":" esriLegendSubFragment")},
k);k=c.create("tbody",{},A);(b._hoverLabel||b._hoverLabels||n)&&this._createHoverAction(A,b,a,n);(m||g.valueExpression||g.legendOptions&&g.legendOptions.title)&&this._addSubHeader(k,this._getRampTitle(g,b,a));m=g.field;var l;m&&(l=e.isFunction(m)?null:this.getField(b,m,a));a=l&&"esriFieldTypeDate"===l.type;f=f||this._getDataValues(d,h,g,a);for(l=A=f.length-1;0<=l;l--)m=f[l],h=P.fromJson(h.toJson()),this._applySize(h,d,g,m),m=a?O.formatDate(m,O.timelineDateFormatOptions):E.format(m),n="",l===A?n=this._specialChars.gt+
" ":0===l&&(n=this._specialChars.lt+" "),n="\x3cspan class\x3d'esriLegendSizeRampLabel'\x3e"+D.encode(n+m)+"\x3c/span\x3e",this._buildRow_Renderer(b,h,null,n,null,k)}},_getSizeSymbol:function(b,a){var c,f;if("esri.renderer.SimpleRenderer"===b.declaredClass)c=b.symbol;else if("esri.renderer.VectorFieldRenderer"===b.declaredClass)c=b.defaultSymbol;else if("esri.renderer.UniqueValueRenderer"===b.declaredClass||"esri.renderer.ClassBreaksRenderer"===b.declaredClass)c=b.infos[0].symbol,f=1<b.infos.length;
if(c=c&&-1!==c.type.indexOf("fillsymbol")?null:c)if(c=P.fromJson(c.toJson()),a||f)-1!==c.type.indexOf("linesymbol")?c.setColor(new u(this.sizeRampDarkColor)):(c.setColor(new u(this.sizeRampLightColor)),c.setOutline&&(f=new U,f.setColor(new u(this.sizeRampDarkColor)),f.setWidth(1.5),c.setOutline(f)));return c},_getDataValues:function(b,a,c,e,g,h){g=null==g?5:g;h=null==h?20:h;var f=b.getSizeRangeAtScale(c,this.map.getScale());g=this._interpolateSizeRange(f,g);var l=this._getDataRange(c),k=d.map(g,function(b){return this._getDataValueFromSize(b,
l,f)},this);if(!e){var r,k=E.round(k);for(e=1;e<k.length-1;e++)if(r=this._roundDataValue(b,a,c,k[e],k[e-1],h))k[e]=r[0],g[e]=r[1]}return k},_getDataRange:function(b){var a=b.stops;return a?{min:a[0].value,max:a[a.length-1].value}:{min:b.minDataValue,max:b.maxDataValue}},_interpolateSizeRange:function(b,a){var c=b.minSize,f=(b.maxSize-c)/(a-1),d,e=[];for(d=0;d<a;d++)e.push(c+f*d);return e},_getDataValueFromSize:function(b,a,c){var f=c.minSize;c=c.maxSize;var d=a.min;a=a.max;return b<=f?d:b>=c?a:(b-
f)/(c-f)*(a-d)+d},_roundDataValue:function(b,a,c,d,e,g){var f=this._getSize(a,b,c,d);e=this._getSize(a,b,c,e);var h,l=E.getDigits(d),k=l.integer,l=l.fractional,r,m,n,w,z,q,t,u,v,x,y;0<d&&1>d&&(h=Math.pow(10,l),d*=h,k=E.getDigits(d).integer);for(--k;0<=k&&(r=Math.pow(10,k),l=Math.floor(d/r)*r,r*=Math.ceil(d/r),null!=h&&(l/=h,r/=h),m=(l+r)/2,m=E.round([l,m,r],{indexes:[1]})[1],n=this._getSize(a,b,c,l),w=this._getSize(a,b,c,r),z=this._getSize(a,b,c,m),q=E.getPctChange(f,n,e,null),t=E.getPctChange(f,
w,e,null),u=E.getPctChange(f,z,e,null),v=q.prev<=g,x=t.prev<=g,v&&x&&(q.prev<=t.prev?(v=!0,x=!1):(x=!0,v=!1)),v?y=[l,n]:x?y=[r,w]:u.prev<=g&&(y=[m,z]),!y);k--);return y},_applySize:function(b,a,c,d){var f=b.type;a=this._getSize(b,a,c,d);switch(f){case "simplemarkersymbol":b.setSize(a);break;case "picturemarkersymbol":f=b.width;c=b.height;b.setHeight(a);b.setWidth(f/c*a);break;case "simplelinesymbol":case "cartographiclinesymbol":b.setWidth(a);break;case "textsymbol":b.font&&b.font.setSize(a)}},_getSize:function(b,
a,c,d){return a.getSize(d,{sizeInfo:c,scale:this.map.getScale(),shape:-1!==b.type.indexOf("markersymbol")?b.style:null})},_buildRow_Renderer:function(b,a,d,e,g,h,k){var f=c.create("tr",{},h),l;this.alignRight?(h=c.create("td",{align:this._isRightToLeft?"left":"right"},f),a&&(l=c.create("td",{align:this._isRightToLeft?"left":"right",width:35},f))):(a&&(l=c.create("td",{width:35,align:"center"},f)),h=c.create("td",{},f));var m=f=30,r;if(a){if("simplemarkersymbol"==a.type)f=Math.min(Math.max(f,a.size+
12),125),m=Math.min(Math.max(m,a.size+12),125);else if("picturemarkersymbol"==a.type)f=Math.min(Math.max(f,a.width),125),m=Math.min(a.height||m,125);else if("textsymbol"==a.type){var n,w;a.text||(n=a.text,w=!0,a.setText(this.defaultText));f=Math.min(Math.max(f,a.getWidth()+12),125);m=Math.min(Math.max(m,a.getHeight()+12),125);w&&a.setText(n)}r=c.create("div",{style:"width:"+f+"px;height:"+m+"px;"},l)}K.isDefined(e)&&"number"===typeof e&&(e=""+e);c.create("td",{innerHTML:e||"",align:this._align},c.create("tr",
{},c.create("tbody",{},c.create("table",{width:"95%"},h))));a&&(b=this._drawSymbol(r,a,d,f,m,g,b,k),this._surfaceItems.push(b))},_addSubHeader:function(a,f){var b=c.create("tr",{},a),b=c.create("td",{align:this._align,colspan:2},b);c.create("td",{innerHTML:D.encode(f)||"",align:this._align},c.create("tr",{},c.create("tbody",{},c.create("table",{width:"95%"},b))))},_drawSymbol:function(a,c,d,g,h,k,n,q){c=P.fromJson(c.toJson());var b=n.opacity;d&&c.setColor(new u(d.toRgba()));if("simplelinesymbol"===
c.type||"cartographiclinesymbol"===c.type||"textsymbol"===c.type){if(!c.color)return;d=c.color.toRgba();d[3]*=b;c.color.setColor(d)}else"simplemarkersymbol"===c.type||"simplefillsymbol"===c.type?(c.color&&(d=c.color.toRgba(),d[3]*=b,c.color.setColor(d)),c.outline&&c.outline.color&&(d=c.outline.color.toRgba(),d[3]*=b,c.outline.color.setColor(d))):"picturemarkersymbol"===c.type&&(a.style.opacity=b,a.style.filter="alpha(opacity\x3d("+100*b+"))");a=v.createSurface(a,g,h);9>m("ie")&&(d=a.getEventSource(),
x.set(d,"position","relative"),x.set(d.parentNode,"position","relative"));k=this._getDrawingToolShape(c,k)||P.getShapeDescriptors(c);var f,b=(d=k.defaultShape)&&"text"===d.type;try{b&&!d.text&&(d.text=this.defaultText),f=a.createShape(q||d).setFill(k.fill).setStroke(k.stroke),b&&f.setFont(k.font)}catch(fa){a.clear();a.destroy();return}var l=f.getBoundingBox();q=l.width;k=l.height;var b=-(l.x+q/2),r=-(l.y+k/2);d=a.getDimensions();b={dx:b+d.width/2,dy:r+d.height/2};if("simplemarkersymbol"===c.type&&
"path"===c.style)g=n._getScaleMatrix(l,c.size),f.applyTransform(H.scaleAt(g.xx,g.yy,{x:d.width/2,y:d.height/2}));else if(q>g||k>h)n=q/g>k/h,g=((n?g:h)-5)/(n?q:k),e.mixin(b,{xx:g,yy:g});f.applyTransform(b);return a},_getDrawingToolShape:function(a,c){var b;switch(c?c.drawingTool||null:null){case "esriFeatureEditToolArrow":b={type:"path",path:"M 10,1 L 3,8 L 3,5 L -15,5 L -15,-2 L 3,-2 L 3,-5 L 10,1 Z"};break;case "esriFeatureEditToolTriangle":b={type:"path",path:"M -10,14 L 2,-10 L 14,14 L -10,14 Z"};
break;case "esriFeatureEditToolRectangle":b={type:"path",path:"M -10,-10 L 10,-10 L 10,10 L -10,10 L -10,-10 Z"};break;case "esriFeatureEditToolCircle":b={type:"circle",cx:0,cy:0,r:10};break;case "esriFeatureEditToolEllipse":b={type:"ellipse",cx:0,cy:0,rx:10,ry:5};break;default:return null}return{defaultShape:b,fill:a.getFill(),stroke:a.getStroke()}},_repaintItems:function(){d.forEach(this._surfaceItems,function(a){this._repaint(a)},this)},_repaint:function(a){if(a){a.getStroke&&a.setStroke&&a.setStroke(a.getStroke());
try{a.getFill&&a.setFill&&a.setFill(a.getFill())}catch(f){}a.children&&e.isArray(a.children)&&d.forEach(a.children,this._repaint,this)}},_createHoverAction:function(a,d,h,k){if(k=d._hoverLabel||d._hoverLabels&&d._hoverLabels[h.id]||k)k=D.encode(k),d.mouseMoveHandler=d.mouseMoveHandler||{},d.mouseMoveHandler[h.id]=g.connect(a,"onmousemove",e.hitch(this,function(a,b){this.mouseX=b.clientX;this.mouseY=b.clientY;this.hoverLabelShowing&&(this.hoverLabelShowing=!1,x.set(q.byId(this.id+"_hoverLabel"),"display",
"none"));setTimeout(e.hitch(this,function(a,b,d){if(a==this.mouseX&&b==this.mouseY&&!this.hoverLabelShowing)if(this.hoverLabelShowing=!0,q.byId(this.id+"_hoverLabel")){var f=q.byId(this.id+"_hoverLabel");f.innerHTML="\x3cspan\x3e"+d+"\x3c/span\x3e";x.set(f,"top",b+"px");x.set(f,"left",a+15+"px");x.set(f,"display","")}else c.create("div",{innerHTML:"\x3cspan\x3e"+d+"\x3c/span\x3e",id:this.id+"_hoverLabel","class":"esriLegendHoverLabel",style:{top:b+"px",left:a+15+"px"}},document.body)},b.clientX,b.clientY,
a),500)},k)),d.mouseOutHandler=d.mouseOutHandler||{},d.mouseOutHandler[h.id]=g.connect(a,"onmouseout",e.hitch(this,function(a){this.mouseY=this.mouseX=-1;this.hoverLabelShowing&&(this.hoverLabelShowing=!1,x.set(q.byId(this.id+"_hoverLabel"),"display","none"))}))},_removeHoverHandlers:function(){var a;d.forEach(this.layers,function(b){if(b.mouseMoveHandler)for(a in b.mouseMoveHandler)g.disconnect(b.mouseMoveHandler[a]);if(b.mouseOutHandler)for(a in b.mouseOutHandler)g.disconnect(b.mouseOutHandler[a])})},
_createDynamicLayers:function(a){var b=[],c;d.forEach(a.dynamicLayerInfos||a.layerInfos,function(d){c={id:d.id};c.source=d.source&&d.source.toJson();var f;a.layerDefinitions&&a.layerDefinitions[d.id]&&(f=a.layerDefinitions[d.id]);f&&(c.definitionExpression=f);var e;a.layerDrawingOptions&&a.layerDrawingOptions[d.id]&&(e=a.layerDrawingOptions[d.id]);e&&(c.drawingInfo=e.toJson());c.minScale=d.minScale||0;c.maxScale=d.maxScale||0;b.push(c)});return b},_getTemplateFromTypes:function(a,c){var b;for(b=0;b<
a.length;b++)if(a[b].id==c&&a[b].templates&&0<a[b].templates.length)return a[b].templates[0];return null},_findParentGroup:function(a,c,d){var b,f=c.dynamicLayerInfos||c.layerInfos;for(b=0;b<f.length;b++)if(d==f[b].id){-1<f[b].parentLayerId&&(x.set(q.byId(this.id+"_"+a+"_"+f[b].parentLayerId+"_group"),"display","block"),this._findParentGroup(a,c,f[b].parentLayerId));break}},_addSubLayersToHide:function(a){function b(c,f){var e=a.layer.dynamicLayerInfos||a.layer.layerInfos,g,h;for(g=0;g<e.length;g++)if(e[g].id===
c&&e[g].subLayerIds)for(h=0;h<e[g].subLayerIds.length;h++){var k=e[g].subLayerIds[h];-1===d.indexOf(f,k)&&(f.push(k),b(k,f))}}a.layer.layerInfos&&d.forEach(this.hideLayersInLegend[a.layer.id],function(c){b(c,this.hideLayersInLegend[a.layer.id])},this)},_isLayerInScale:function(a,c,d){var b,f=!0;if(a.legendResponse&&a.legendResponse.layers)for(b=0;b<a.legendResponse.layers.length;b++){var e=a.legendResponse.layers[b];if(c.id==e.layerId){var g,h;!a.minScale&&0!==a.minScale||!a.maxScale&&0!==a.maxScale?
(0==e.minScale&&a.tileInfo&&(g=a.tileInfo.lods[0].scale),0==e.maxScale&&a.tileInfo&&(h=a.tileInfo.lods[a.tileInfo.lods.length-1].scale)):(g=Math.min(a.minScale,e.minScale)||a.minScale||e.minScale,h=Math.max(a.maxScale,e.maxScale));if(0<g&&g<d||h>d)f=!1;break}}else if(a.minScale||a.maxScale)if(a.minScale&&a.minScale<d||a.maxScale&&a.maxScale>d)f=!1;return f},_getServiceTitle:function(a){var b=a._titleForLegend;b||(b=a.url,a.url?-1<a.url.indexOf("/MapServer")?(b=a.url.substring(0,a.url.indexOf("/MapServer")),
b=b.substring(b.lastIndexOf("/")+1,b.length)):-1<a.url.indexOf("/ImageServer")?(b=a.url.substring(0,a.url.indexOf("/ImageServer")),b=b.substring(b.lastIndexOf("/")+1,b.length)):-1<a.url.indexOf("/FeatureServer")&&(b=a.url.substring(0,a.url.indexOf("/FeatureServer")),b=b.substring(b.lastIndexOf("/")+1,b.length)):b="",a.name&&(b=0<b.length?b+(" - "+a.name):a.name));"esri.layers.ArcGISImageServiceVectorLayer"===a.declaredClass&&a.vectorFieldPixelFilter&&(a=a.vectorFieldPixelFilter.outputUnit?this["NLS_"+
a.vectorFieldPixelFilter.outputUnit]:this["NLS_"+a.vectorFieldPixelFilter.inputUnit],K.isDefined(a)&&(b+=" ("+a+")"));return D.encode(b)},_getEffectiveScale:function(a,c){var b=c.minScale,d=c.maxScale;if(K.isDefined(c.parentLayerId)){var e=a.layerInfos,f=c.parentLayerId,g;for(g=e.length-1;0<=g;g--)if(e[g].id==f)if(0==b&&0<e[g].minScale?b=e[g].minScale:0<b&&0==e[g].minScale||0<b&&0<e[g].minScale&&(b=Math.min(b,e[g].minScale)),d=Math.max(d||0,e[g].maxScale||0),-1<e[g].parentLayerId)f=e[g].parentLayerId;
else break}return{minScale:b,maxScale:d}},_isSupportedLayerType:function(a){return a&&("esri.layers.ArcGISDynamicMapServiceLayer"===a.declaredClass||"esri.layers.ArcGISImageServiceLayer"===a.declaredClass&&10.2<=a.version||"esri.layers.ArcGISImageServiceVectorLayer"===a.declaredClass||"esri.layers.ArcGISTiledMapServiceLayer"===a.declaredClass||"esri.layers.FeatureLayer"===a.declaredClass||"esri.layers.StreamLayer"===a.declaredClass||"esri.layers.KMLLayer"===a.declaredClass||"esri.layers.GeoRSSLayer"===
a.declaredClass||"esri.layers.WMSLayer"===a.declaredClass||"esri.layers.WFSLayer"===a.declaredClass||"esri.layers.CSVLayer"===a.declaredClass)?!0:!1},isHostedTileService:function(a){var b=/(https?:)?\/\/services.*\.arcgis\.com/i;return"esri.layers.ArcGISTiledMapServiceLayer"===a.declaredClass&&b.test(a.url)?!0:!1},getField:function(a,c,e){if(a.getField)return a.getField(c);if(e&&e.fields){var b;d.forEach(e.fields,function(a){a.name===c&&(b=a)});return b}return null}});e.mixin(M,{ALIGN_LEFT:0,ALIGN_RIGHT:1});
m("extend-esri")&&e.setObject("dijit.Legend",M,Q);return M});